<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8">
  <title>PASTRIMI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --bg:#0a0f18; --ink:#ffffff; --muted:#a7b0c9;
      --panel:#0f1626; --br:#2a3550; --ghost:#121a2b;
      --primary:#1e60ff; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1{font-size:22px;margin:12px 12px 8px;font-weight:1000}

    .topbar{display:flex;gap:8px;flex-wrap:wrap;margin:0 12px 10px}
    .btn{background:#1a2235;border:1px solid var(--br);padding:6px 10px;border-radius:8px;
         color:#fff;font-weight:800;font-size:13px;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn.primary{background:var(--primary)}
    .btn.ghost{background:var(--ghost)}
    .btn.ok{background:var(--ok);color:#06210e}
    .btn.warn{background:var(--warn);color:#1f1302}
    .btn.danger{background:var(--danger)}
    .topbar .badge{cursor:pointer}

    .orders{margin:0 12px 96px}
    .empty{color:var(--muted);border:1px dashed var(--br);border-radius:10px;padding:10px;text-align:center;font-weight:900}

    .order{background:var(--panel);border:1px solid var(--br);border-radius:10px;padding:8px;margin-bottom:8px;font-size:13px}
    .head{display:flex;justify-content:space-between;gap:8px;margin-bottom:6px}
    .name{font-weight:1000;font-size:14px}
    .code{color:#a5d8ff;font-weight:1000}
    .stat{color:#d7e6ff;font-weight:900;display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted);font-weight:800}
    .actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}

    .footer{position:fixed;left:0;right:0;bottom:0;background:#0b0f18;border-top:1px solid var(--br)}
    .footwrap{max-width:980px;margin:0 auto;padding:10px;display:flex;gap:8px}
    .footwrap .btn{flex:1;justify-content:center}
    .small-note{color:var(--muted);font-size:11px;margin:0 12px 6px}
  </style>
</head>
<body>
  <h1>PASTRIMI</h1>
  <div class="topbar">
    <a class="btn" href="../">Këthehu te Home</a>
    <a class="btn" href="../pranimi/">PRANIM</a>
    <a class="btn" href="../pastrimi/">PASTRIM</a>
    <a class="btn badge" id="debugBtn">Lista e porosive</a>
    <a class="btn ghost" id="refreshBtn">↻ Rifresko</a>
  </div>
  <div class="small-note" id="dataSourceNote">Burimi: localStorage</div>

  <div class="orders" id="orders"></div>

  <div class="footer">
    <div class="footwrap">
      <a class="btn" href="../">← Home</a>
      <a class="btn primary" href="../pranimi/">+ PRANIM I RI</a>
    </div>
  </div>

  <!-- Supabase client (CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  (function(){
    // ===== 1) KONFIG SUPABASE (shkruaj këtu kredencialet e tua) =====
    const SUPABASE_URL = "https://vnidjrxidvusulinozbn.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaWRqcnhpZHZ1c3VsaW5vemJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTk0NjAsImV4cCI6MjA3MzA5NTQ2MH0.hzGSFKU3sKuUKBUBsTE0rKIerj2uhG9pGS8_K9N7tpA";
    // ===============================================================

    const LIST  = document.getElementById('orders');
    const note  = document.getElementById('dataSourceNote');

    const q=(s,b)=> (b||document).querySelector(s);
    const r2=x=>Math.round((x+Number.EPSILON)*100)/100;

    function readAllLocal(){
      const out=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && k.startsWith('order_')){
          try{ const o=JSON.parse(localStorage.getItem(k)||'{}'); if(o&&o.id) out.push(o); }catch(e){}
        }
      }
      out.sort((a,b)=>(b.ts||0)-(a.ts||0));
      return out;
    }

    async function readAllSupabase(){
      if(!SUPABASE_URL || !SUPABASE_ANON || !window.supabase) return {rows:[], ok:false, err:'no-config'};
      const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      try{
        const { data, error } = await client
          .from('orders')
          .select('id, ts, status, client_name, client_phone, client_code, pay_m2, pay_rate, pay_euro, tepiha, staza, shkallore')
          .in('status', ['pranim','pastrim'])
          .order('ts', { ascending: false })
          .limit(200);

        if(error) throw error;

        // Mapo në formatin lokal
        const mapped = (data||[]).map(r => ({
          id: r.id,
          ts: r.ts || Date.now(),
          status: r.status || 'pranim',
          client: { name: r.client_name||'', phone: r.client_phone||'', code: r.client_code||'' },
          pay: { m2: Number(r.pay_m2||0), rate: Number(r.pay_rate||0), euro: Number(r.pay_euro||0) },
          tepiha: r.tepiha || [],
          staza:  r.staza  || [],
          shkallore: r.shkallore || { qty:0, per:0 }
        }));
        return {rows:mapped, ok:true};
      }catch(err){
        console.warn('Supabase read failed:', err);
        return {rows:[], ok:false, err:String(err)};
      }
    }

    function pieces(o){
      const t=(o?.tepiha||[]).length;
      const s=(o?.staza||[]).length;
      const stairs=(o?.shkallore?.qty||0)>0?1:0;
      return t+s+stairs;
    }
    function m2(o){
      if(o?.pay?.m2) return Number(o.pay.m2); // nëse vjen gati nga DB
      const t=(o?.tepiha||[]).reduce((s,r)=>s+(Number(r.m2||0)*Number(r.qty||1)),0);
      const s=(o?.staza||[] ).reduce((s,r)=>s+(Number(r.m2||0)*Number(r.qty||1)),0);
      const sh=Number(o?.shkallore?.qty||0)*Number(o?.shkallore?.per||0);
      return r2(t+s+sh);
    }
    function eur(o){
      if(o?.pay?.euro) return Number(o.pay.euro);
      return r2(m2(o) * Number(o?.pay?.rate||0));
    }
    function digits(o){ return String(o?.client?.phone||'').replace(/[^\d]/g,''); }
    function saveLocal(o){ try{ localStorage.setItem('order_'+o.id, JSON.stringify(o)); }catch(e){ alert('S’u ruajt: '+e); } }

    function msgText(o){
      const name = o?.client?.name || 'Klient';
      return `Përshëndetje ${name}, procesi i pastrimit ka filluar.\n`+
             `Keni ${pieces(o)} copë = ${m2(o).toFixed(2)} m².\n`+
             `Totali: ${eur(o).toFixed(2)} €.\nFaleminderit!`;
    }

    function actionSheetForMessage(o){
      const txt = encodeURIComponent(msgText(o));
      const d   = digits(o);
      const links = [
        {label:'Viber',    href:`viber://forward?text=${txt}`},
        {label:'WhatsApp', href: d ? `https://wa.me/${d}?text=${txt}` : `https://wa.me/?text=${txt}`},
        {label:'SMS',      href: d ? `sms:${d}?body=${txt}` : `sms:?body=${txt}`},
      ];
      const ov=document.createElement('div');
      ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:flex-end;justify-content:center;z-index:99999';
      const box=document.createElement('div');
      box.style.cssText='background:#0d1320;border:1px solid #2a3550;border-radius:12px 12px 0 0;width:100%;max-width:760px;padding:12px';
      const h=document.createElement('div'); h.textContent='Dërgo me:'; h.style.cssText='font-weight:1000;margin:0 4px 8px';
      box.appendChild(h);
      links.forEach(l=>{
        const a=document.createElement('a');
        a.href=l.href; a.target='_blank'; a.rel='noopener';
        a.textContent=l.label;
        a.style.cssText='display:block;background:#1e60ff;color:#fff;text-decoration:none;padding:12px;border-radius:10px;font-weight:900;margin:6px 4px;text-align:center';
        box.appendChild(a);
      });
      const cancel=document.createElement('button');
      cancel.textContent='Anulo'; cancel.className='btn ghost';
      cancel.style.cssText='width:100%;margin:6px 4px 0';
      cancel.onclick=()=>ov.remove();
      box.appendChild(cancel);
      ov.appendChild(box);
      ov.addEventListener('click',ev=>{ if(ev.target===ov) ov.remove(); });
      document.body.appendChild(ov);
    }

    function render(list){
      LIST.innerHTML='';
      if(!list.length){
        LIST.innerHTML = '<div class="empty">S’ka porosi për t’u shfaqur.</div>';
        return;
      }
      const frag=document.createDocumentFragment();
      list.forEach(o=>{
        const card=document.createElement('div'); card.className='order';
        card.innerHTML = `
          <div class="head">
            <div class="name">${o?.client?.name||'—'} <span class="code">${o?.client?.code||''}</span></div>
            <div class="muted">${(o?.status||'').toUpperCase()}</div>
          </div>
          <div class="stat">
            <span><b>${pieces(o)}</b> copë</span>
            <span><b>${m2(o).toFixed(2)}</b> m²</span>
            <span><b>${eur(o).toFixed(2)}</b> €</span>
            <span class="muted">Tel: ${o?.client?.phone||'—'}</span>
          </div>
          <div class="actions">
            <button class="btn warn"  data-act="start" data-id="${o.id}">Starto pastrimin</button>
            <button class="btn ok"    data-act="ready" data-id="${o.id}">Kalo GATI</button>
            <button class="btn ghost" data-act="msg"   data-id="${o.id}">Mesazh</button>
            <a class="btn primary"    data-act="call"  data-id="${o.id}" href="tel:${digits(o)}">Telefono</a>
          </div>
        `;
        frag.appendChild(card);
      });
      LIST.appendChild(frag);
    }

    function mergeById(primary, secondary){
      // primary fiton (p.sh. supabase) – secondary (local) mbush boshllëqet
      const map = new Map();
      primary.forEach(o=>map.set(o.id, o));
      secondary.forEach(o=>{
        if(!map.has(o.id)) map.set(o.id, o);
      });
      return Array.from(map.values()).sort((a,b)=>(b.ts||0)-(a.ts||0));
    }

    async function load(){
      // 1) local
      const local = readAllLocal().filter(o=>['pranim','pastrim'].includes((o?.status||'').toLowerCase()));
      let finalList = local;
      note.textContent = 'Burimi: localStorage';

      // 2) supabase (opsional)
      const {rows:remote, ok} = await readAllSupabase();
      if(ok && remote.length){
        finalList = mergeById(remote, local);
        note.textContent = 'Burimi: Supabase + localStorage';
      }

      render(finalList);
    }

    function handleClick(e){
      const el = e.target.closest('[data-act]');
      if(!el) return;
      const id  = el.getAttribute('data-id');
      const act = el.getAttribute('data-act');
      const raw = localStorage.getItem('order_'+id);
      // Veprimet poshtë prekin **localStorage** – për Supabase sink do e bëjmë në një hap tjetër.
      if(!raw){ return alert('Porosia nuk u gjet në këtë pajisje (localStorage).'); }
      let o; try{ o=JSON.parse(raw); }catch(_){ return alert('Porosia e korruptuar.'); }

      if(act==='start'){
        o.status='pastrim'; o.ts=Date.now(); saveLocal(o); load();
      } else if(act==='ready'){
        o.status='gati'; o.ts=Date.now(); saveLocal(o);
        window.location.href = '../gati/';
      } else if(act==='msg'){
        actionSheetForMessage(o);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', load);
    document.addEventListener('click', handleClick);

    // Debug
    document.getElementById('debugBtn').addEventListener('click', ()=>{
      const orders=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k && k.startsWith('order_')){
          try{ orders.push(JSON.parse(localStorage.getItem(k)||'{}')); }catch(e){}
        }
      }
      alert(
        (orders.length? 'U gjetën '+orders.length+' porosi:\n\n':'S’u gjet asnjë.')
        + orders.map(o=>`${o.id} | status=${o.status} | ${o?.client?.name||''}`).join('\n')
      );
    });

    load();
  })();
  </script>
</body>
</html>