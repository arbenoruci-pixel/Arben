<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PASTRIMI</title>
  <style>
    :root{ --bg:#000; --ink:#fff; --panel:#0c0f16; --br:#273143; --btn:#1e60ff; --muted:#b9c4da; --danger:#ef4444; --ok:#22c55e }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:clamp(34px,5.4vw,50px);margin:14px 6px 10px;font-weight:1000}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 6px 16px}
    .input{flex:1;min-width:200px;background:#070a12;border:2px solid #2c3954;border-radius:12px;padding:12px 14px;color:#fff;font-weight:900}
    .btn{background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:1000;cursor:pointer}
    .btn.ghost{background:#0c1220;border:2px solid var(--br)}
    .btn.ok{background:var(--ok)}
    .btn.red{background:var(--danger)}
    .list{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--panel);border:1px solid var(--br);border-radius:14px;padding:14px}
    .top{display:flex;justify-content:space-between;align-items:center;font-weight:1000}
    .small{opacity:.85;font-size:.95rem}
    .row{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
    .row2{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .status{padding:4px 8px;border-radius:8px;border:1px solid var(--br);font-weight:1000}
    a.btnlink{display:inline-flex;align-items:center;gap:6px;background:#0c1220;border:1px solid var(--br);padding:10px 12px;border-radius:10px;color:#fff;text-decoration:none;font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PASTRIMI</h1>
    <div class="bar">
      <input class="input" id="q" placeholder="K√´rko: em√´r, kod X#, tel‚Ä¶">
      <button class="btn" id="refresh">REFRESKO</button>
      <a class="btnlink" href="../">üè† KTHEU N√ã FILLIM</a>
      <a class="btnlink" href="../pranimi/">‚ûï SHTO T√ã RE</a>
    </div>
    <div class="list" id="orders">Duke u ngarkuar‚Ä¶</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    const CFG = {
      supabase: {
        url: "https://vnidjrxidvusulinozbn.supabase.co",
        anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaWRqcnhpZHZ1c3VsaW5vemJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTk0NjAsImV4cCI6MjA3MzA5NTQ2MH0.hzGSFKU3sKuUKBUBsTE0rKIerj2uhG9pGS8_K9N7tpA",
        bucket: "tepiha-photos"
      }
    };
    const sb = supabase.createClient(CFG.supabase.url, CFG.supabase.anonKey);

    async function listFiles(){
      const { data: files, error } = await sb.storage
        .from(CFG.supabase.bucket)
        .list('orders', { limit: 1000, sortBy: { column: 'name', order: 'desc' } });
      if(error){ throw error; }
      return (files||[]).filter(f=>f.name.endsWith('.json'));
    }

    async function publicUrl(path){
      const { data } = sb.storage.from(CFG.supabase.bucket).getPublicUrl(path);
      return data?.publicUrl || null;
    }

    async function fetchOrderWithPath(name){
      const path = `orders/${name}`;
      const url = await publicUrl(path);
      if(!url) return null;
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) return null;
      const json = await res.json();
      // bashkangjit path-in q√´ ta dim√´ √ßfar√´ t√´ upsertojm√´ kur ndryshojm√´ statusin
      json.__path = path;
      return json;
    }

    function sanitizeDigits(s){ return (s||'').replace(/[^\d]/g,''); }

    function msgGati(o){
      const name = o?.client?.name || 'Klient';
      const code = o?.client?.code || '';
      const euro = Number(o?.pay?.euro||0).toFixed(2);
      return `Pershendetje ${name}. Porosia #${code} eshte GATI per marrje. Totali: ${euro} ‚Ç¨. Faleminderit!`;
    }

    function contactLinks(o, text){
      const phone = sanitizeDigits(o?.client?.phone||'');
      const enc = encodeURIComponent(text);
      const viber = `viber://forward?text=${enc}`;
      const wa = phone ? `https://wa.me/${phone}?text=${enc}` : `https://wa.me/?text=${enc}`;
      const sms = phone ? `sms:${phone}?body=${enc}` : `sms:?body=${enc}`;
      return { viber, wa, sms };
    }

    async function upsertOrder(o){
      // heqen fushat e brendshme
      const copy = JSON.parse(JSON.stringify(o));
      delete copy.__path;
      const blob = new Blob([JSON.stringify(copy)], { type: 'application/json' });
      const { error } = await sb.storage
        .from(CFG.supabase.bucket)
        .upload(o.__path, blob, { upsert:true, contentType:'application/json' });
      if(error) throw error;
    }

    function render(orders){
      const root = document.getElementById('orders');
      root.innerHTML = '';
      if(!orders.length){ root.textContent = 'S‚Äôka porosi t√´ sinkronizuara.'; return; }

      const term = (document.getElementById('q')?.value||'').toLowerCase().trim();
      const filtered = orders.filter(o=>{
        if(!term) return true;
        const name = (o?.client?.name||'').toLowerCase();
        const code = (o?.client?.code||'').toLowerCase();
        const phone= (o?.client?.phone||'').toLowerCase();
        return name.includes(term)||code.includes(term)||phone.includes(term);
      });

      filtered.sort((a,b)=> (b?.ts||0) - (a?.ts||0));

      if(!filtered.length){ root.textContent = 'Asgj√´ nuk p√´rputhet me k√´rkimin.'; return; }

      for(const o of filtered){
        const div = document.createElement('div');
        div.className = 'card';
        const m2 = (o?.pay?.m2 ?? 0);
        const euro = (o?.pay?.euro ?? 0);
        const st = (o?.status||'pranim').toUpperCase();

        const msg = msgGati(o);
        const links = contactLinks(o, msg);

        div.innerHTML = `
          <div class="row">
            <div class="top">
              <div><b>#${o?.client?.code || '-'}</b> ‚Äî ${o?.client?.name || 'Pa em√´r'}</div>
              <div class="status">${st}</div>
            </div>
            <div class="small">M¬≤: ${m2} &nbsp;|&nbsp; ‚Ç¨: ${Number(euro).toFixed(2)}</div>
            <div class="small">${o?.client?.phone||''}</div>
          </div>
          <div class="row2">
            <button class="btn ok act-gati">B√ãJE GATI</button>
            <a class="btn ghost" target="_blank" rel="noopener" href="${links.viber}">D√ãRGO ‚Äî Viber</a>
            <a class="btn ghost" target="_blank" rel="noopener" href="${links.wa}">D√ãRGO ‚Äî WhatsApp</a>
            <a class="btn ghost" target="_blank" rel="noopener" href="${links.sms}">D√ãRGO ‚Äî SMS</a>
            <a class="btn ghost" href="${await publicUrl(o.__path)}" target="_blank" rel="noopener">SHKARKO JSON</a>
          </div>
        `;

        // Wire "B√ãJE GATI"
        div.querySelector('.act-gati').addEventListener('click', async ()=>{
          try{
            const old = div.querySelector('.status').textContent;
            div.querySelector('.status').textContent = 'GATI';
            o.status = 'gati';
            await upsertOrder(o);
          }catch(err){
            alert('S‚Äôu p√´rdit√´sua: ' + (err?.message||err));
          }
        });

        root.appendChild(div);
      }
    }

    async function load(){
      try{
        const files = await listFiles();
        const orders = [];
        for(const f of files){
          const o = await fetchOrderWithPath(f.name);
          if(o) orders.push(o);
        }
        render(orders);
      }catch(err){
        document.getElementById('orders').textContent = 'Gabim gjat√´ ngarkimit: ' + (err?.message||err);
      }
    }

    document.getElementById('refresh').addEventListener('click', load);
    document.getElementById('q').addEventListener('input', load);
    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>