<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRANIMI (Dark + Supabase)</title>
  <style>
    :root{
      /* PURE DARK: black canvas, white text */
      --bg:#000000;
      --panel:#0d0f14;
      --panel-br:#202633;
      --ink:#ffffff;
      --muted:#a8b3c7;
      --line:#253045;

      --chip-bg:#141b26;
      --chip-br:#2c3a55;
      --chip-ink:#cfe2ff;
      --chip-bg-hover:#1a2434;

      --btn:#1e60ff;
      --btn-ink:#ffffff;
      --btn-ghost:#0f1420;
      --btn-ghost-br:#2b3956;

      --accent:#22c55e; /* badge green */
      --accent-ink:#062e17;

      --danger:#ef4444;

      --shadow: 0 10px 35px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      line-height:1.25;
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 0 16px 140px; }

    h1{
      font-size: clamp(34px, 5.4vw, 50px);
      margin: 20px 6px 6px; font-weight: 1000; letter-spacing:.01em;
      display:flex; align-items:center; gap:12px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.10));
      border:1px solid rgba(34,197,94,.55);
      color:#c6ffd9;
      padding:10px 16px; border-radius: 999px;
      font-weight: 1000; font-size: 18px; letter-spacing:.04em;
    }

    .card{
      background:var(--panel); border:1px solid var(--panel-br);
      border-radius:18px; padding:18px; margin:16px 0; box-shadow:var(--shadow);
    }
    .title{
      display:flex; align-items:center; justify-content:space-between;
      font-size: clamp(20px, 2.6vw, 28px); font-weight: 1000; margin-bottom: 12px;
    }
    label{ font-size:16px; color:var(--muted); font-weight:900; letter-spacing:.04em }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px }
    @media (max-width:720px){ .row{ grid-template-columns:1fr } }

    .input{
      width:100%;
      background:#05070c; border:2px solid var(--line);
      border-radius:14px; padding:16px 18px;
      font-size:22px; font-weight:1000; color:var(--ink);
      outline:none;
    }
    .input:focus{ border-color:#6aa1ff; box-shadow:0 0 0 3px rgba(30,96,255,.25); }

    .chips{ display:flex; flex-wrap:wrap; gap:12px; padding:6px 0 }
    .chip{
      flex:0 0 auto; border:2px solid var(--chip-br);
      background:var(--chip-bg); color:var(--chip-ink);
      border-radius:999px; padding:12px 18px; font-weight:1000; font-size:20px;
      min-height:52px;
    }
    .chip:active,.chip:hover{ background:var(--chip-bg-hover); }

    .list{ display:flex; flex-direction:column; gap:12px; margin-top:8px }
    .piece-row{ display:grid; grid-template-columns: 130px 1fr 150px; gap:12px; align-items:center }
    .piece-id{
      background:#062413; border:2px solid rgba(34,197,94,.55);
      color:#a6ffbe; border-radius:12px; padding:16px 14px; text-align:center;
      font-weight:1000; font-size:22px;
    }

    .mwrap{ display:flex; align-items:center; gap:10px }

    .btnbar{ display:flex; gap:12px; flex-wrap:wrap; margin-top:8px }
    .btn{
      border:0; border-radius:14px; padding:16px 22px; min-height:56px;
      font-weight:1000; font-size:20px; letter-spacing:.02em; cursor:pointer;
      background:var(--btn); color:var(--btn-ink);
    }
    .btn.red{ background:var(--danger); }
    .btn.ghost{ background:var(--btn-ghost); color:#cfe2ff; border:2px solid var(--btn-ghost-br); }

    .tot{
      display:flex; justify-content:space-between; align-items:center;
      background:#0b111d; border:1px solid var(--panel-br);
      border-radius:12px; padding:12px 14px; margin-top:10px;
      font-size:22px; font-weight:1000;
    }
    .pill{ background:#0b111d; border:1px solid var(--panel-br);
      border-radius:12px; padding:12px 14px; font-weight:1000; font-size:22px }

    /* Footer â€“ large touch area */
    body{ padding-bottom: 140px }
    .footer{
      position:fixed; left:0; right:0; bottom:0; z-index:10;
      background:rgba(5,7,12,.96); border-top:1px solid var(--panel-br); backdrop-filter:blur(6px);
    }
    .footwrap{
      max-width:980px; margin:0 auto; padding:12px 16px;
      display:grid; grid-template-columns:1fr auto auto; gap:12px; align-items:center;
    }

    /* Camera button & thumbnails */
    .cam-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:56px; height:56px; min-width:56px;
      border:2px solid var(--btn-ghost-br); border-radius:12px;
      background:#0a1220; cursor:pointer; font-size:26px; user-select:none; color:#cfe2ff;
    }
    .thumb{
      width:56px; height:56px; border-radius:12px; object-fit:cover; display:none;
      border:2px solid var(--btn-ghost-br); cursor:pointer;
    }

    a.btn{text-decoration:none; display:inline-flex; align-items:center; justify-content:center}
  </style>
</head>
<body>
  <h1>PRANIMI <span class="badge" id="ticketCode">KODI: â€”â€”</span></h1>

  <input type="hidden" id="orderId" value="">
  <div class="wrap">

    <!-- KLIENTI -->
    <section class="card">
      <div class="title">
        <span>Hapi 1 â€” Klienti</span>
        <img id="clientThumb" class="thumb" alt="">
      </div>
      <div class="row">
        <div>
          <label>EMRI &amp; MBIEMRI*</label>
          <div style="display:flex;align-items:center;gap:12px;">
            <input class="input" id="name" placeholder="p.sh. Arben R.">
            <label class="cam-btn" title="Foto klientit">ðŸ“·
              <input type="file" accept="image/*" capture="environment" id="clientPhotoInput" style="display:none">
            </label>
          </div>
        </div>
        <div>
          <label>TELEFONI*</label>
          <div class="row" style="grid-template-columns:160px 1fr">
            <input class="input" id="phonePrefix" value="+383" readonly>
            <input class="input" id="phone" inputmode="numeric" placeholder="44177778">
          </div>
        </div>
      </div>
    </section>

    <!-- TEPIHA -->
    <section class="card" id="sec-tepiha">
      <div class="title"><span>Tepiha</span></div>
      <div class="chips" id="chips-tepiha">
        <button class="chip">2.0 mÂ²</button><button class="chip">2.5 mÂ²</button><button class="chip">3.0 mÂ²</button><button class="chip">3.2 mÂ²</button><button class="chip">3.5 mÂ²</button><button class="chip">3.7 mÂ²</button><button class="chip">6.0 mÂ²</button><button class="chip">Manual</button>
      </div>
      <div class="list" id="list-tepiha"></div>
      <div class="btnbar">
        <button class="btn" onclick="addRow('tepiha', null)">+ Rresht</button>
        <button class="btn red" onclick="removeRow('tepiha')">âˆ’ Rresht</button>
      </div>
      <div class="tot"><span>Totali tepiha:</span><b id="tot-tepiha">0.00 mÂ²</b></div>
    </section>

    <!-- STAZA -->
    <section class="card" id="sec-staza">
      <div class="title"><span>Staza</span></div>
      <div class="chips" id="chips-staza">
        <button class="chip">1.5 mÂ²</button><button class="chip">2.0 mÂ²</button><button class="chip">2.2 mÂ²</button><button class="chip">3.0 mÂ²</button><button class="chip">Manual</button>
      </div>
      <div class="list" id="list-staza"></div>
      <div class="btnbar">
        <button class="btn" onclick="addRow('staza', null)">+ Rresht</button>
        <button class="btn red" onclick="removeRow('staza')">âˆ’ Rresht</button>
      </div>
      <div class="tot"><span>Totali staza:</span><b id="tot-staza">0.00 mÂ²</b></div>
    </section>

    <!-- SHKALLORE -->
    <section class="card" id="sec-shkallore">
      <div class="title"><span>Shkallore</span></div>
      <div class="row">
        <div><label>Sasia (numri i hapave)</label><input class="input" id="stairsQty" inputmode="numeric" placeholder="p.sh. 20"></div>
        <div><label>MÂ² pÃ«r hap</label><input class="input" id="stairsPer" inputmode="decimal" value="0.3"></div>
      </div>
      <div class="btnbar" id="stairsCamWrap">
        <label class="cam-btn">ðŸ“·
          <input type="file" accept="image/*" capture="environment" id="stairsPhotoInput" style="display:none">
        </label>
      </div>
      <div class="tot"><span>MÂ² shkallore:</span><b id="stairsM2">0.00 mÂ²</b></div>
    </section>

    <!-- PAGESA -->
    <section class="card">
      <div class="title"><span>Pagesa</span></div>
      <div class="row">
        <div><label>â‚¬ / mÂ²</label><input class="input" id="rate" inputmode="decimal" value="2.50"></div>
        <div>
          <label>PAGUAR NÃ‹ FILLIM (CASH)</label><br>
          <label style="display:flex;align-items:center;gap:12px; font-size:20px; font-weight:1000">
            <input type="checkbox" id="paidUpfront" style="width:28px;height:28px"> <span>Aktivo futjen e shumÃ«s</span>
          </label>
        </div>
      </div>
      <div class="row">
        <div><label>KLIENTI DHA (â‚¬)</label><input class="input" id="clientPaid" inputmode="decimal" placeholder="p.sh. 50" disabled></div>
        <div><label>BORXHI (â‚¬)</label><input class="input" id="debt" readonly></div>
      </div>
      <div class="row">
        <div><label>KTHE (â‚¬)</label><input class="input" id="change" readonly></div>
        <div class="pill"><b>Total (â‚¬):</b> <span id="euroTotal">0.00</span></div>
      </div>
      <div class="row">
        <div class="pill"><b>MÂ² total:</b> <span id="m2Total">0.00</span></div>
      </div>
    </section>

    <!-- FOOTER -->
    <div class="footer">
      <div class="footwrap">
        <div class="pill"><b>Totali:</b> <span id="m2TotalFooter">0.00</span> mÂ²</div>
        <button class="btn ghost" id="btnSaveDraft">ðŸ’¾ RUAJ DRAFT</button>
        <a class="btn" id="btnContinue" href="../pastrimi/">â–¶ VAZHDO</a>
      </div>
    </div>
  </div>

  <!-- ===== Supabase client (optional) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <script>
  (function(){
    /* ------------ CONFIGURO KÃ‹TU PÃ‹R SUPABASE ------------- */
    const CFG = {
      supabase: {
        url: "",                          // p.sh. "https://abcd.supabase.co"
        anonKey: "",                      // Anon public key
        bucket: "tepiha-photos"           // krijoje nÃ« Storage (public)
      }
    };
    /* ------------------------------------------------------ */

    function hasSupabase(){
      return typeof window.supabase !== 'undefined'
             && CFG.supabase.url && CFG.supabase.url.startsWith('http')
             && CFG.supabase.anonKey;
    }
    let sb = null;
    if (hasSupabase()){
      sb = supabase.createClient(CFG.supabase.url, CFG.supabase.anonKey);
    }

    /* ===== helpers ===== */
    function q(s,b){ return (b||document).querySelector(s); }
    function qq(s,b){ return Array.prototype.slice.call((b||document).querySelectorAll(s)); }
    function r2(x){ return Math.round((x + Number.EPSILON) * 100)/100; }
    function uid(){ return 'r'+Date.now().toString(36)+Math.random().toString(36).slice(2,7); }

    /* ===== orderId & code ===== */
    var hid = q('#orderId'); if(!hid.value) hid.value = 'ord_'+Date.now();
    var OID = hid.value;

    function loadMap(k){ try{ return JSON.parse(localStorage.getItem(k)||'{}'); }catch(e){ return {}; } }
    function saveMap(k,o){ try{ localStorage.setItem(k, JSON.stringify(o)); }catch(e){} }
    function nextCode(){
      var n = parseInt(localStorage.getItem('client_code_counter')||'0',10)||0;
      n += 1; localStorage.setItem('client_code_counter', String(n));
      return 'X'+n;
    }
    function setBadge(code){ var el=q('#ticketCode'); if(el) el.textContent = code?('KODI: '+code):'KODI: â€”â€”'; }
    var metaKey = 'order_meta_'+OID;
    var meta = loadMap(metaKey);
    if(!meta.code){ meta.code = nextCode(); saveMap(metaKey, meta); }
    setBadge(meta.code);

    function normPhone(v){ return String(v||'').replace(/[^\d\+]/g,'').trim(); }
    function bindClientIdentity(){
      var phone = normPhone(q('#phone') && q('#phone').value);
      var name  = (q('#name') && q('#name').value || '').trim();
      if(phone){
        var byPhone = loadMap('client_code_by_phone'); if(!byPhone[phone]){ byPhone[phone]=meta.code; saveMap('client_code_by_phone', byPhone); }
      }else if(name.length>=3){
        var byName = loadMap('client_code_by_name'); if(!byName[name]){ byName[name]=meta.code; saveMap('client_code_by_name', byName); }
      }
    }
    ['#phone','#name'].forEach(function(sel){ var el=q(sel); if(el) el.addEventListener('blur', bindClientIdentity); });
    window.__getClientCode = function(){ var m=loadMap(metaKey); return m.code||''; };

    /* ===== PHOTO UTILS ===== */
    async function fileToCompressedBlob(file, maxW=1280, maxH=1280, quality=0.75){
      const img = new Image();
      const data = await new Promise((res, rej)=>{ const fr = new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
      await new Promise(r=>{ img.onload=r; img.src=data; });

      let {width, height} = img;
      const r = Math.min(1, maxW/width, maxH/height);
      width = Math.round(width*r); height = Math.round(height*r);
      const c = document.createElement('canvas'); c.width=width; c.height=height;
      c.getContext('2d').drawImage(img,0,0,width,height);
      return await new Promise(res=>c.toBlob(res, 'image/jpeg', quality));
    }
    function openPreview(url){
      var ov=document.createElement('div');
      ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:99999';
      var img=document.createElement('img'); img.src=url; img.style.cssText='max-width:96%;max-height:92%;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.6)';
      ov.appendChild(img); ov.addEventListener('click', ()=>ov.remove()); document.body.appendChild(ov);
    }
    async function savePhoto(key, file){
      try{
        if (sb){ // upload to Supabase
          const blob = await fileToCompressedBlob(file);
          const path = `${OID}/${key}_${Date.now()}.jpg`;
          const { error } = await sb.storage.from(CFG.supabase.bucket).upload(path, blob, { upsert:false, contentType:'image/jpeg' });
          if (error) throw error;
          const { data } = sb.storage.from(CFG.supabase.bucket).getPublicUrl(path);
          localStorage.setItem(key+'_url', data.publicUrl);
          return data.publicUrl;
        } else {
          // fallback: dataURL in localStorage
          const blob = await fileToCompressedBlob(file);
          const arrBuf = await blob.arrayBuffer();
          const base64 = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));
          const url = 'data:image/jpeg;base64,' + base64;
          localStorage.setItem(key+'_url', url);
          return url;
        }
      }catch(e){
        alert('Sâ€™u ruajt fotoja');
        throw e;
      }
    }
    function getPhotoUrl(key){ return localStorage.getItem(key+'_url'); }

    document.addEventListener('click', function(e){
      const btn = e.target.closest('.cam-btn'); if(!btn) return;
      const inp = btn.querySelector('input[type=file]'); if(inp){ try{ inp.click(); }catch(_){} }
    }, {capture:true});

    /* ===== CHIPS ===== */
    (function(){
      function handleChip(section, evt){
        var chip = evt.target.closest && evt.target.closest('.chip'); if(!chip) return;
        var txt=(chip.textContent||'').trim(); var num=parseFloat(txt.replace(/[^\d\.]/g,'')); 
        if(!isNaN(num)) addRow(section, num); else addRow(section, null);
      }
      var t=q('#chips-tepiha'), s=q('#chips-staza');
      if(t && !t.__w){ t.addEventListener('click', e=>handleChip('tepiha',e)); t.__w=1; }
      if(s && !s.__w){ s.addEventListener('click', e=>handleChip('staza',e)); s.__w=1; }
    })();

    /* ===== rows ===== */
    function listFor(section){ return q('#list-'+section); }
    window.addRow = function(section, value){
      var list=listFor(section); if(!list) return;
      var row=document.createElement('div'); row.className='piece-row';

      var idCell=document.createElement('div'); idCell.className='piece-id';
      idCell.textContent = (window.__getClientCode?window.__getClientCode():'X') || 'X';

      var mWrap=document.createElement('div'); mWrap.className='mwrap';
      var m2=document.createElement('input'); m2.className='input piece-input'; m2.placeholder='mÂ²'; m2.setAttribute('inputmode','decimal'); if(value!=null) m2.value=value;

      var cam=document.createElement('label'); cam.className='cam-btn'; cam.textContent='ðŸ“·';
      var file=document.createElement('input'); file.type='file'; file.accept='image/*'; file.capture='environment'; file.style.display='none';
      cam.appendChild(file);

      var thumb=document.createElement('img'); thumb.className='thumb';

      var rid=uid(); var pKey='photo_'+section+'_'+OID+'_'+rid; row.setAttribute('data-photo-key', pKey);
      var prev=getPhotoUrl(pKey); if(prev){ thumb.src=prev; thumb.style.display='inline-block'; cam.style.display='none'; }

      mWrap.appendChild(m2); mWrap.appendChild(cam); mWrap.appendChild(thumb);

      var qty=document.createElement('input'); qty.className='input piece-qty'; qty.placeholder='copÃ«'; qty.setAttribute('inputmode','numeric'); qty.value='1';

      file.addEventListener('change', async function(ev){
        var f=ev.target.files && ev.target.files[0]; if(!f) return;
        try{
          const url = await savePhoto(pKey, f);
          thumb.src=url; thumb.style.display='inline-block'; cam.style.display='none';
        }catch(e){}
      });
      thumb.addEventListener('click', function(){ var url=getPhotoUrl(pKey); if(url) openPreview(url); });

      m2.addEventListener('input', computeTotals);
      qty.addEventListener('input', computeTotals);

      row.appendChild(idCell); row.appendChild(mWrap); row.appendChild(qty);
      list.appendChild(row);
      computeTotals();
    };
    window.removeRow = function(section){
      var list=listFor(section); var rows=qq('.piece-row', list);
      if(rows.length){ rows[rows.length-1].remove(); }
      computeTotals();
    };

    function sectionTotal(section){
      var list=listFor(section); var rows=qq('.piece-row', list);
      var total=r2(rows.reduce(function(s,row){
        var m2=parseFloat(((row.querySelector('.piece-input')||{}).value||'0'))||0;
        var qv=parseFloat(((row.querySelector('.piece-qty')||{}).value||'1'))||1;
        return s + (m2*qv);
      },0));
      var tgt=q('#tot-'+section); if(tgt) tgt.textContent=total.toFixed(2)+' mÂ²';
      return total;
    }

    /* ===== stairs + totals ===== */
    function computeStairs(){
      var qty=parseFloat((q('#stairsQty')&&q('#stairsQty').value)||'0')||0;
      var per=parseFloat((q('#stairsPer')&&q('#stairsPer').value)||'0.3')||0;
      var m2=r2(qty*per); var out=q('#stairsM2'); if(out) out.textContent=m2.toFixed(2)+' mÂ²'; return m2;
    }
    window.computeTotals=function(){
      var tT=sectionTotal('tepiha'), tS=sectionTotal('staza'), tSt=computeStairs();
      var totalM2=r2(tT+tS+tSt);
      var m2El=q('#m2Total'); if(m2El) m2El.textContent=totalM2.toFixed(2);
      var m2F=q('#m2TotalFooter'); if(m2F) m2F.textContent=totalM2.toFixed(2);

      var rate=parseFloat((q('#rate')&&q('#rate').value)||'0')||0;
      var euro=r2(totalM2*rate); var eurEl=q('#euroTotal'); if(eurEl) eurEl.textContent=euro.toFixed(2);

      var paidOn=!!(q('#paidUpfront')&&q('#paidUpfront').checked);
      var paidIn=q('#clientPaid'); if(paidIn) paidIn.disabled=!paidOn; if(!paidOn && paidIn) paidIn.value='';
      var paidVal=paidOn?(parseFloat((paidIn&&paidIn.value)||'0')||0):0;
      var debt=Math.max(0, r2(euro-paidVal));
      var change=Math.max(0, r2(paidVal-euro));
      var debtEl=q('#debt'); if(debtEl) debtEl.value=debt.toFixed(2);
      var changeEl=q('#change'); if(changeEl) changeEl.value=change.toFixed(2);
    };
    ['#stairsQty','#stairsPer','#rate','#paidUpfront','#clientPaid'].forEach(function(sel){
      var el=q(sel); if(!el) return; el.addEventListener(sel==='#paidUpfront'?'change':'input', computeTotals);
    });

    /* ===== client + stairs photo ===== */
    (function(){
      var key='photo_client_'+OID, inp=q('#clientPhotoInput'), th=q('#clientThumb'), saved=getPhotoUrl(key);
      if(saved && th){ th.src=saved; th.style.display='inline-block'; th.addEventListener('click',()=>openPreview(saved)); }
      if(inp){ inp.addEventListener('change', async (e)=>{ var f=e.target.files&&e.target.files[0]; if(!f) return;
        try{ const url=await savePhoto(key, f); if(th){ th.src=url; th.style.display='inline-block'; } }catch(e){}
      });}
      var sinp=q('#stairsPhotoInput'), wrap=q('#stairsCamWrap');
      if(wrap){
        var sSaved=getPhotoUrl('photo_shkallore_'+OID);
        if(sSaved){ var t=document.createElement('img'); t.className='thumb'; t.style.display='inline-block'; t.src=sSaved; t.addEventListener('click',()=>openPreview(sSaved)); wrap.appendChild(t); }
      }
      if(sinp){ sinp.addEventListener('change', async (e)=>{ var f=e.target.files&&e.target.files[0]; if(!f) return;
        try{ const url=await savePhoto('photo_shkallore_'+OID, f); openPreview(url); }catch(e){} });
      }
    })();

    /* ===== save draft ===== */
    var LIST_KEY='order_list_v1'; function KEY(id){ return 'order_'+id; }
    function getId(){ return OID; }
    function readRows(listId){
      var list=q('#list-'+listId); if(!list) return [];
      return qq('.piece-row', list).map(function(row){
        return {
          m2: parseFloat(((row.querySelector('.piece-input')||{}).value||'0'))||0,
          qty: parseFloat(((row.querySelector('.piece-qty')||{}).value||'1'))||1,
          photoKey: row.getAttribute('data-photo-key')
        };
      });
    }
    function totalsObj(){
      var m2=parseFloat((q('#m2Total')&&q('#m2Total').textContent)||'0')||0;
      var rate=parseFloat((q('#rate')&&q('#rate').value)||'0')||0;
      var euro=r2(m2*rate);
      var paidUp=(q('#paidUpfront')&&q('#paidUpfront').checked);
      var paid=paidUp?(parseFloat((q('#clientPaid')&&q('#clientPaid').value)||'0')||0):0;
      var debt=Math.max(0, r2(euro-paid)); var change=Math.max(0, r2(paid-euro));
      return {m2, rate, euro, paidUp, paid, debt, change};
    }
    function saveIndexEntry(){
      var idx=[]; try{ idx=JSON.parse(localStorage.getItem(LIST_KEY)||'[]'); }catch(e){ idx=[]; }
      var entry={ id:getId(), name:(q('#name')?q('#name').value.trim():''), phone: ((q('#phonePrefix')?q('#phonePrefix').value:'') + (q('#phone')?q('#phone').value.trim():'')) };
      var i=idx.findIndex(x=>x.id===entry.id); if(i>=0) idx[i]=entry; else idx.unshift(entry);
      localStorage.setItem(LIST_KEY, JSON.stringify(idx.slice(0,200)));
    }
    function saveDraft(){
      var id=getId();
      var data={
        id, ts:Date.now(),
        client:{ name:(q('#name')?q('#name').value.trim():''), phone: ((q('#phonePrefix')?q('#phonePrefix').value:'') + (q('#phone')?q('#phone').value.trim():'')),
                 code:(window.__getClientCode?window.__getClientCode():''), photoKey:'photo_client_'+id },
        tepiha: readRows('tepiha'),
        staza:  readRows('staza'),
        shkallore:{ qty: parseFloat((q('#stairsQty')&&q('#stairsQty').value)||'0')||0, per: parseFloat((q('#stairsPer')&&q('#stairsPer').value)||'0.3')||0, photoKey:'photo_shkallore_'+id },
        pay: totalsObj(),
        status:'pranim'
      };
      try{ localStorage.setItem(KEY(id), JSON.stringify(data)); saveIndexEntry(); return true; }
      catch(e){ alert('Sâ€™u ruajt drafti (storage i plotÃ«?)'); return false; }
    }
    var btnSave=q('#btnSaveDraft'); if(btnSave) btnSave.addEventListener('click', e=>{ e.preventDefault(); saveDraft(); });

    /* start */
    computeTotals();
  })();
  </script>

  <!-- DEBUG kundÃ«r â€œfaqes sÃ« bardhÃ«â€ -->
  <script>
    window.addEventListener('error', function(e){
      document.body.innerHTML =
        '<pre style="white-space:pre-wrap;color:#fff;background:#111;padding:12px;border:1px solid #333">' +
        (e.message||'JS error') + '\n' + (e.filename||'') + ':' + (e.lineno||'') +
        '</pre>';
    });
  </script>
</body>
</html>