<script>
/* ==================== PRANIMI: Foto + Totale (Shqip) ==================== */
(function(){
  /* --- utilitare tÃ« thjeshta --- */
  function q(s,b){ return (b||document).querySelector(s); }
  function qq(s,b){ return Array.from((b||document).querySelectorAll(s)); }
  function r2(x){ return Math.round((x + Number.EPSILON) * 100)/100; }
  function uid(){ return 'r'+Date.now().toString(36)+Math.random().toString(36).slice(2,7); }

  /* --- ruajtje/lexim foto nÃ« localStorage --- */
  function savePhotoFromFile(key, file){
    return new Promise((res, rej)=>{
      const rd = new FileReader();
      rd.onload = ()=>{ try{ localStorage.setItem(key, rd.result); res(rd.result); }catch(e){ rej(e); } };
      rd.onerror = rej;
      rd.readAsDataURL(file);
    });
  }
  function getPhoto(key){ try{ return localStorage.getItem(key); }catch(e){ return null; } }

  /* --- overlay preview full-screen --- */
  function openPreview(dataURL){
    const ov = document.createElement('div');
    Object.assign(ov.style,{
      position:'fixed', inset:'0', background:'rgba(0,0,0,.85)',
      display:'flex', alignItems:'center', justifyContent:'center', zIndex:99999
    });
    const img = document.createElement('img');
    img.src = dataURL; img.alt = 'Foto';
    Object.assign(img.style,{maxWidth:'96%', maxHeight:'92%', borderRadius:'10px', boxShadow:'0 10px 40px rgba(0,0,0,.6)'});
    ov.appendChild(img);
    ov.addEventListener('click', ()=> ov.remove());
    document.body.appendChild(ov);
  }

  /* =============== LOGJIKA E RRESHTAVE (TEPIHA / STAZA) =============== */
  function listFor(section){ return q('#list-'+section); }

  // Stil i vogÃ«l pÃ«r butonin ðŸ“· (nÃ«se sâ€™e ke nÃ« CSS)
  function styleCam(el){
    Object.assign(el.style,{
      display:'inline-flex', alignItems:'center', justifyContent:'center',
      width:'44px', height:'44px', border:'1px solid rgba(124,168,255,.35)',
      borderRadius:'10px',
      background:'linear-gradient(180deg, rgba(24,34,78,.9), rgba(16,26,56,.9))',
      cursor:'pointer', fontSize:'18px', userSelect:'none'
    });
  }

  // shto rresht
  window.addRow = function(section, value){
    const list = listFor(section); if(!list) return;
    const row = document.createElement('div');
    row.className = 'piece-row';
    const idCell = document.createElement('div');
    idCell.className = 'piece-id';
    idCell.textContent = '#' + String(qq('.piece-row', list).length + 1).padStart(2,'0');

    // *** kolona mÂ²: input + ðŸ“· brenda sÃ« njÃ«jtÃ«s qelizÃ« ***
    const mWrap = document.createElement('div');
    Object.assign(mWrap.style,{display:'flex', gap:'6px', alignItems:'center'});
    const m2 = document.createElement('input');
    m2.className = 'input piece-input';
    m2.placeholder = 'mÂ²'; m2.inputMode = 'decimal'; if(value!=null) m2.value = value;

    const cam = document.createElement('label');
    styleCam(cam);
    cam.textContent = 'ðŸ“·';
    const file = document.createElement('input');
    file.type='file'; file.accept='image/*'; file.capture='environment'; file.style.display='none';
    cam.appendChild(file);

    // thumbnail i vogÃ«l (shfaqet pas ruajtjes)
    const thumb = document.createElement('img');
    Object.assign(thumb.style,{width:'44px', height:'44px', borderRadius:'10px', objectFit:'cover', display:'none', border:'1px solid rgba(124,168,255,.35)'});
    // ID unike pÃ«r key fotoje (sâ€™prishen kur fshin/shton rreshta)
    const rid = uid();
    row.dataset.photoKey = `photo_${section}_${rid}`;

    mWrap.appendChild(m2);
    mWrap.appendChild(cam);
    mWrap.appendChild(thumb);

    // kolona copÃ« (qty)
    const qty = document.createElement('input');
    qty.className = 'input piece-qty'; qty.placeholder='copÃ«'; qty.inputMode='numeric'; qty.value='1';

    // eventi: ruaj foto â†’ shfaq thumbnail â†’ hap me prekje
    file.addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0]; if(!f) return;
      try{
        const data = await savePhotoFromFile(row.dataset.photoKey, f);
        thumb.src = data; thumb.style.display='inline-block';
        cam.style.display='none'; // fshi ikonÃ«n pasi ruhet
      }catch(e){ alert('Sâ€™u ruajt fotoja'); }
    });
    thumb.addEventListener('click', ()=>{ const d=getPhoto(row.dataset.photoKey); if(d) openPreview(d); });

    // wire totali
    m2.addEventListener('input', computeTotals);
    qty.addEventListener('input', computeTotals);

    // montimi
    row.appendChild(idCell);
    row.appendChild(mWrap);
    row.appendChild(qty);
    list.appendChild(row);
    computeTotals();
  };

  // fshi rresht
  window.removeRow = function(section){
    const list = listFor(section);
    const rows = qq('.piece-row', list);
    if(rows.length){ rows[rows.length-1].remove(); }
    // rinumÃ«ro etiketa #01, #02...
    qq('.piece-row', list).forEach((r,i)=>{ const c=r.querySelector('.piece-id'); if(c) c.textContent = '#'+String(i+1).padStart(2,'0'); });
    computeTotals();
  };

  // totali i njÃ« seksioni
  function sectionTotal(section){
    const list = listFor(section);
    const rows = qq('.piece-row', list);
    const total = r2(rows.reduce((s,row)=>{
      const m2 = parseFloat((row.querySelector('.piece-input')||{}).value||'0')||0;
      const qv = parseFloat((row.querySelector('.piece-qty')||{}).value||'1')||1;
      return s + (m2*qv);
    }, 0));
    const tgt = q('#tot-'+section); if (tgt) tgt.textContent = total.toFixed(2) + ' mÂ²';
    return total;
  }

  /* ==================== LLOGARITJE TOTALE ==================== */
  function computeStairs(){
    const qty = parseFloat(q('#stairsQty')?.value||'0')||0;
    const per = parseFloat(q('#stairsPer')?.value||'0.3')||0;
    const m2 = r2(qty * per);
    const out=q('#stairsM2'); if(out) out.textContent = m2.toFixed(2) + ' mÂ²';
    return m2;
  }

  window.computeTotals = function(){
    const tT = sectionTotal('tepiha');
    const tS = sectionTotal('staza');
    const tStairs = computeStairs();
    const totalM2 = r2(tT + tS + tStairs);
    const m2El=q('#m2Total'); if(m2El) m2El.textContent = totalM2.toFixed(2);
    const m2F=q('#m2TotalFooter'); if(m2F) m2F.textContent = totalM2.toFixed(2);

    const rate = parseFloat(q('#rate')?.value||'0')||0;
    const euro = r2(totalM2 * rate);
    const eurEl=q('#euroTotal'); if(eurEl) eurEl.textContent = euro.toFixed(2);

    const paidToggle = q('#paidUpfront');
    const paidOn = !!(paidToggle && paidToggle.checked);
    const paidIn = q('#clientPaid');
    if(paidIn) paidIn.disabled = !paidOn;
    if(!paidOn && paidIn) paidIn.value = '';

    const paidVal = paidOn ? (parseFloat(paidIn?.value||'0')||0) : 0;
    const debt = Math.max(0, r2(euro - paidVal));
    const change = Math.max(0, r2(paidVal - euro));
    const debtEl=q('#debt'); if(debtEl) debtEl.value = debt.toFixed(2);
    const changeEl=q('#change'); if(changeEl) changeEl.value = change.toFixed(2);
  };

  // lidh inputet e fiksuara
  ['#stairsQty','#stairsPer','#rate','#paidUpfront','#clientPaid'].forEach(sel=>{
    const el = q(sel); if(!el) return;
    el.addEventListener(sel==='#paidUpfront' ? 'change' : 'input', computeTotals);
  });

  // chips â†’ shto rreshta shpejt
  function wireChips(id, section){
    qq('#'+id+' .chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const txt=(btn.textContent||'').trim();
        const num=parseFloat(txt.replace(/[^\d\.]/g,'')); 
        if(!isNaN(num)) addRow(section, num); else addRow(section, null);
      });
    });
  }
  wireChips('chips-tepiha','tepiha'); wireChips('chips-staza','staza');

  /* ==================== FOTO: KLIENTI & SHKALLORE ==================== */
  // klienti â€“ ruaj + thumbnail + hapje
  (function(){
    const inp = q('#clientPhotoInput');
    const thumb = q('#clientThumb');
    const saved = getPhoto('photo_client');
    if(saved && thumb){ thumb.src = saved; thumb.style.display='inline-block'; thumb.style.cursor='pointer'; }
    if(thumb){ thumb.addEventListener('click', ()=>{ const d=getPhoto('photo_client'); if(d) openPreview(d); }); }
    if(inp){
      inp.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        try{
          const data = await savePhotoFromFile('photo_client', f);
          if(thumb){ thumb.src = data; thumb.style.display='inline-block'; thumb.style.cursor='pointer'; }
        }catch(e){ alert('Sâ€™u ruajt fotoja e klientit'); }
      });
    }
  })();

  // shkallore â€“ njÃ« foto unike
  (function(){
    const wrap = q('#stairsCamWrap');
    const inp = q('#stairsPhotoInput');
    if(wrap){
      wrap.style.display='flex'; wrap.style.gap='10px';
      const saved = getPhoto('photo_shkallore');
      if(saved){
        const t = document.createElement('img');
        Object.assign(t.style,{width:'44px', height:'44px', borderRadius:'10px', objectFit:'cover', border:'1px solid rgba(124,168,255,.35)'});
        t.src = saved; t.addEventListener('click', ()=>openPreview(saved));
        wrap.appendChild(t);
      }
    }
    if(inp){
      inp.addEventListener('change', async ev=>{
        const f = ev.target.files && ev.target.files[0]; if(!f) return;
        try{
          const data = await savePhotoFromFile('photo_shkallore', f);
          openPreview(data); // hap menjÃ«herÃ« pÃ«r konfirmim
        }catch(e){ alert('Sâ€™u ruajt fotoja e shkallore'); }
      });
    }
  })();

  /* ==================== RUAJ DRAFT ==================== */
  const LIST_KEY='order_list_v1'; const KEY=id=>`order_${id}`;
  function getId(){ const hid=q('#orderId'); if(hid.value) return hid.value; const id='ord_'+Date.now(); hid.value=id; return id; }
  function readRows(listId){
    const list=q('#list-'+listId); if(!list) return [];
    return qq('.piece-row', list).map((row)=>({
      m2: parseFloat(row.querySelector('.piece-input')?.value||'0')||0,
      qty: parseFloat(row.querySelector('.piece-qty')?.value||'1')||1,
      photoKey: row.dataset.photoKey || null
    }));
  }
  function totalsObj(){
    const m2=parseFloat(q('#m2Total')?.textContent||'0')||0;
    const rate=parseFloat(q('#rate')?.value||'0')||0;
    const euro=r2(m2*rate);
    const paidUp=q('#paidUpfront')?.checked;
    const paid=paidUp?(parseFloat(q('#clientPaid')?.value||'0')||0):0;
    const debt=Math.max(0, r2(euro-paid));
    const change=Math.max(0, r2(paid-euro));
    return {m2, rate, euro, paidUp, paid, debt, change};
  }
  function saveIndexEntry(id, name, phone){
    let idx=[]; try{ idx=JSON.parse(localStorage.getItem(LIST_KEY)||'[]'); }catch(e){ idx=[]; }
    const i=idx.findIndex(x=>x.id===id);
    const entry={id, name:(q('#name')?.value||'').trim(), phone:(`${q('#phonePrefix')?.value||''}${(q('#phone')?.value||'').trim()}`)};
    if(i>=0) idx[i]=entry; else idx.unshift(entry);
    localStorage.setItem(LIST_KEY, JSON.stringify(idx.slice(0,200)));
  }
  function saveDraft(){
    const id=getId();
    const data={
      id, ts:Date.now(),
      client:{ name: (q('#name')?.value||'').trim(), phone: `${q('#phonePrefix')?.value||''}${(q('#phone')?.value||'').trim()}`, photoKey:'photo_client' },
      tepiha: readRows('tepiha'),
      staza: readRows('staza'),
      shkallore:{ qty: parseFloat(q('#stairsQty')?.value||'0')||0, per: parseFloat(q('#stairsPer')?.value||'0.3')||0, photoKey:'photo_shkallore' },
      pay: totalsObj(),
      status:'pranim'
    };
    try{
      localStorage.setItem(KEY(id), JSON.stringify(data));
      saveIndexEntry();
      return true;
    }catch(e){ alert('Sâ€™u ruajt dot drafti (localStorage i plotÃ«?)'); return false; }
  }
  const btnSave=q('#btnSaveDraft'); if(btnSave){ btnSave.addEventListener('click', (e)=>{ e.preventDefault(); saveDraft(); }); }

  /* start */
  computeTotals();
})();
</script>