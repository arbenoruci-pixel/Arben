<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PASTRIMI • Lista</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f1a2a; --line:#1f2e46;
  --ink:#eaf1ff; --muted:#9fb4d6;
  --blue1:#1aa5d8; --blue2:#146b95; --green:#19a25f; --red:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a111c,#0b1220);color:var(--ink);
     font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;letter-spacing:.2px}
a{color:inherit;text-decoration:none}
.wrap{max-width:980px;margin:0 auto;padding:12px}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
.title{font-weight:1000;font-size:18px;letter-spacing:.4px}
.badge{background:linear-gradient(180deg,var(--blue1),var(--blue2));padding:4px 10px;border-radius:999px;font-weight:1000;font-size:12px;border:1px solid #1f6f97}

/* list */
.panel{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:12px;padding:6px}
.head,.row{
  display:grid;
  grid-template-columns: 54px minmax(80px,1fr) 68px 136px; /* X | Emri | m² | actions */
  gap:6px; align-items:center;
}
.head{color:var(--muted);font-weight:900;font-size:12px;padding:4px 6px}
.row{padding:6px;border-top:1px solid #12233a;font-size:13px;white-space:nowrap}
.x{font-weight:900}
.name{overflow:hidden;text-overflow:ellipsis}
.m2{font-variant-numeric:tabular-nums;text-align:right}
.actions{display:flex;gap:6px;justify-content:flex-end}

/* compact buttons */
.btn{border:1px solid #2aa7d8;border-radius:8px;background:linear-gradient(180deg,var(--blue1),var(--blue2));
     color:#fff;font-weight:800;cursor:pointer;padding:5px 8px;font-size:12px;line-height:1}
.btn.alt{background:var(--green);border-color:#157c46}
.btn:active{transform:translateY(1px)}

/* footer */
.footer{position:fixed;left:0;right:0;bottom:0;background:rgba(10,17,28,.96);
        border-top:1px solid var(--line);backdrop-filter:blur(6px);z-index:10}
.footwrap{max-width:980px;margin:0 auto;padding:10px;display:flex;gap:8px;justify-content:space-between}
.navbtn{border:1px solid #2aa7d8;border-radius:10px;background:linear-gradient(180deg,var(--blue1),var(--blue2));
        color:#fff;font-weight:900;padding:10px 12px;font-size:13px}

/* bottom sheet (long-press options) */
.sheet-ov{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;z-index:9999}
.sheet{width:100%;max-width:720px;background:#0c0f16;border:1px solid #273143;border-radius:12px 12px 0 0;padding:12px}
.sheet h3{margin:4px 6px 8px;font-size:15px}
.opt{display:block;text-align:center;margin:6px 0;padding:12px;border-radius:10px;font-weight:900;color:#fff}
.opt.viber{background:#7e57c2;border:1px solid #5e3aa6}
.opt.wa{background:#25d366;border:1px solid #128c7e}
.opt.sms{background:#c78a2a;border:1px solid #8a5f19}
.opt.copy{background:#0e1730;border:1px solid #2b3956}
.opt.cancel{background:#0c1220;border:1px solid #2b3956}
.helper{color:#9fb4d6;font-size:12px;margin:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">PASTRIMI</div>
    <div class="badge" id="countBadge">0 aktive</div>
  </div>

  <div class="panel">
    <div class="head"><div>X nr</div><div>Emri</div><div style="text-align:right">m²</div><div style="text-align:right">Veprime</div></div>
    <div id="list">—</div>
  </div>
</div>

<div class="footer">
  <div class="footwrap">
    <a class="navbtn" href="../">KTHEU NË FILLIM</a>
    <button class="navbtn" onclick="location.reload()">RIFRESKO</button>
  </div>
</div>

<!-- Options sheet -->
<div class="sheet-ov" id="sheetOv">
  <div class="sheet">
    <h3>Zgjidh platformën</h3>
    <a class="opt viber" id="optViber" target="_blank" rel="noopener">Viber</a>
    <a class="opt wa" id="optWA" target="_blank" rel="noopener">WhatsApp</a>
    <a class="opt sms" id="optSMS" target="_blank" rel="noopener">SMS</a>
    <a class="opt copy" id="optCopy">Kopjo tekstin</a>
    <a class="opt cancel" id="optCancel">Anulo</a>
  </div>
</div>

<script>
(function(){
  const LIST_KEY='order_list_v1'; const KEY=id=>'order_'+id;
  const getIndex=()=>{try{return JSON.parse(localStorage.getItem(LIST_KEY)||'[]')}catch(e){return []}};
  const getOrder=id=>{try{return JSON.parse(localStorage.getItem(KEY(id))||'null')}catch(e){return null}};
  const r2=x=>Math.round((x+Number.EPSILON)*100)/100;

  const padX = code => {
    const m=/^X(\d+)$/i.exec(String(code||'')); if(!m) return code||'—';
    const n=+m[1]; return n<10?`X0${n}`:`X${n}`;
  };
  const piecesCount = o => (o.tepiha?.length||0)+(o.staza?.length||0)+((o.shkallore?.qty>0)?1:0);
  const m2Compute = o => {
    if(o?.pay?.m2>0) return r2(o.pay.m2);
    const sum=a=>(a||[]).reduce((s,x)=>s+(+x.m2||0)*(+x.qty||1),0);
    const st=r2((+o?.shkallore?.qty||0)*(+o?.shkallore?.per||0));
    return r2(sum(o?.tepiha)+sum(o?.staza)+st);
  };
  const euroCompute = o => (o?.pay?.euro>0? r2(o.pay.euro) : r2(m2Compute(o)*(+o?.pay?.rate||2.5)));

  // --- build message & links
  function buildMessage(o){
    const name=o?.client?.name||'Klient';
    const x=padX(o?.client?.code||'');
    const pcs=piecesCount(o);
    const m2=m2Compute(o).toFixed(2);
    const euro=euroCompute(o).toFixed(2);
    return `Përshëndetje ${name}, porosia juaj (${x}) është GATI për marrje. Keni ${pcs} copë = ${m2} m². Totali: ${euro} €. Ju lutem ejani sot deri në ora 21:00. Nuk kemi hapësirë për ruajtje afatgjatë. Tel: +38344735312`;
  }
  function buildLinks(o){
    const body=encodeURIComponent(buildMessage(o));
    const digits=String(o?.client?.phone||'').replace(/[^\d]/g,'');
    return {
      viber:`viber://forward?text=${body}`,
      wa: digits?`https://wa.me/${digits}?text=${body}`:`https://wa.me/?text=${body}`,
      sms:digits?`sms:${digits}?body=${body}`:`sms:?body=${body}`,
      text:decodeURIComponent(body)
    };
  }

  // --- mark GATI
  function markGati(o){
    const updated={...o,status:'gati',ts:Date.now()};
    localStorage.setItem(KEY(o.id), JSON.stringify(updated));
  }

  // --- bottom sheet
  const sheetOv=document.getElementById('sheetOv');
  const optViber=document.getElementById('optViber');
  const optWA=document.getElementById('optWA');
  const optSMS=document.getElementById('optSMS');
  const optCopy=document.getElementById('optCopy');
  const optCancel=document.getElementById('optCancel');
  function openSheet(links){
    optViber.href=links.viber; optWA.href=links.wa; optSMS.href=links.sms;
    optCopy.onclick=(e)=>{e.preventDefault(); navigator.clipboard?.writeText(links.text).then(()=>alert('Teksti u kopjua.'));};
    [optViber,optWA,optSMS,optCancel].forEach(a=>a.onclick=()=>sheetOv.style.display='none');
    sheetOv.style.display='flex';
    sheetOv.onclick=(e)=>{ if(e.target===sheetOv) sheetOv.style.display='none'; };
  }

  // --- Dërgo behavior: tap=Viber, long-press=options
  function wireSend(btn, order){
    const links=buildLinks(order);
    let timer=null, long=false;
    const start=()=>{ long=false; timer=setTimeout(()=>{ long=true; openSheet(links); }, 550); };
    const end=()=>{ clearTimeout(timer); if(!long){ window.location.href=links.viber; setTimeout(()=>{ try{ window.open(links.wa,'_blank'); }catch{} }, 800); markGati(order); btn.closest('.row')?.remove(); updateCount(); } };
    btn.addEventListener('touchstart', start, {passive:true});
    btn.addEventListener('touchend', end);
    btn.addEventListener('mousedown', start);
    btn.addEventListener('mouseup', end);
  }

  function buildRow(o){
    const row=document.createElement('div'); row.className='row';
    const m2=m2Compute(o).toFixed(2);
    row.innerHTML=`
      <div class="x">${padX(o?.client?.code)}</div>
      <div class="name" title="${o?.client?.name||''}">${o?.client?.name||'(pa emër)'}</div>
      <div class="m2">${m2} m²</div>
      <div class="actions">
        <button class="btn" data-act="msg">Dërgo</button>
        <button class="btn alt" data-act="done">Gati</button>
      </div>`;
    wireSend(row.querySelector('[data-act="msg"]'), o);
    row.querySelector('[data-act="done"]').addEventListener('click', ()=>{ markGati(o); row.remove(); updateCount(); });
    return row;
  }

  function updateCount(){
    const n=document.querySelectorAll('#list .row').length;
    document.getElementById('countBadge').textContent=`${n} aktive`;
    if(n===0) document.getElementById('list').textContent='— S’ka punë aktive.';
  }

  function load(){
    const list=document.getElementById('list'); list.innerHTML='';
    const idx=getIndex(); let any=false;
    for(const r of idx){
      const o=getOrder(r.id); if(!o) continue;
      if(String(o.status||'').toLowerCase()!=='pastrim') continue;
      list.appendChild(buildRow(o)); any=true;
    }
    if(!any) list.textContent='— S’ka punë aktive.';
    updateCount();
  }

  load();
})();
</script>
</body>
</html>