<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ARKA • Historia e Ditëve</title>
<style>
:root{
  --bg:#0b1220; --bg2:#0a111c;
  --panel:#0f1a2a; --line:#1f2e46;
  --text:#eaf1ff; --muted:#9fb4d6;
  --blue1:#1aa5d8; --blue2:#146b95;
  --green1:#19a25f; --green2:#0e6d3d;
  --amber1:#c78a2a; --amber2:#8a5f19;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}
.app{max-width:980px;margin:0 auto;padding:16px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:14px;padding:14px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#254369,#15263c);border:1px solid #203651;display:flex;align-items:center;justify-content:center}
.brand h1{margin:0;font-size:18px;letter-spacing:.6px}
.kv{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;border:1px solid #2aa7d8;color:#fff;font-weight:800;letter-spacing:.4px;background:linear-gradient(180deg,var(--blue1),var(--blue2));cursor:pointer}
.btn.ghost{background:#0f182b}
.btn.green{background:linear-gradient(180deg,var(--green1),var(--green2));border-color:#14804b}
.btn.amber{background:linear-gradient(180deg,var(--amber1),var(--amber2));border-color:#8a5f19}
.small{color:var(--muted);font-size:12px}
.input{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e1730;color:#fff;font-weight:900;letter-spacing:.5px}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
.list .row{display:grid;grid-template-columns: 160px 1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f182b}
.list .row .date{font-weight:900}
.sectionTitle{font-weight:1000;margin:12px 0 8px}
.details{margin-top:10px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.details .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0f182b;border-bottom:1px solid var(--line)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
.pill{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;border-radius:999px;border:1px solid var(--line);background:#0f182b}
.footerBtns{display:flex;gap:8px;flex-wrap:wrap}
hr.sep{border:0;border-top:1px solid var(--line);margin:12px 0}
.note{font-size:12px;color:#bcd0ef}
</style>

<!-- jsPDF + html2canvas for PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo">💶</div>
      <div>
        <h1>ARKA — HISTORIA</h1>
        <div class="small">Ditët e mbyllura • eksport • PDF • dërgesë email</div>
      </div>
    </div>
    <div class="kv">
      <a class="btn ghost" href="../">🏠 HOME</a>
      <a class="btn ghost" href="./">⬅︎ ARKA</a>
    </div>
  </div>

  <div class="panel">
    <div class="kv">
      <button class="btn" id="filterThisWeek">Këtë javë</button>
      <button class="btn" id="filter7">7 ditët</button>
      <div class="pill">
        <span>Prej</span><input class="input" type="date" id="from">
        <span>Deri</span><input class="input" type="date" id="to">
        <button class="btn" id="filterRange">Filtro</button>
      </div>
      <div class="pill">
        <span>Email:</span>
        <input class="input" id="emailTo" style="width:240px">
        <button class="btn green" id="saveEmail">Ruaj</button>
      </div>
    </div>

    <hr class="sep">

    <div class="sectionTitle">Ditët</div>
    <div id="daysList" class="list"></div>

    <div id="dayDetails" class="details" style="display:none">
      <div class="head">
        <div id="dayTitle"><b>Dita:</b> —</div>
        <div class="footerBtns">
          <button class="btn amber" id="btnCSV">Export CSV</button>
          <button class="btn" id="btnPDF">Krijo PDF</button>
          <button class="btn green" id="btnSendEmail">Ngarko & Dërgo Email</button>
        </div>
      </div>
      <div id="dayBody" style="padding:12px"></div>
      <div class="note" style="padding:8px 12px">Shënim: PDF ruhet në Supabase dhe linku futet në email. Për dërgesë automatike me server mund të shtojmë më vonë një Edge Function.</div>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const CFG = {
  supabase: {
    url: "https://vnidjrxidvusulinozbn.supabase.co",
    anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaWRqcnhpZHZ1c3VsaW5vemJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTk0NjAsImV4cCI6MjA3MzA5NTQ2MH0.hzGSFKU3sKuUKBUBsTE0rKIerj2uhG9pGS8_K9N7tpA",
    bucket: "tepiha-photos" // we’ll store reports under folder 'reports/'
  }
};
const sb = (typeof supabase!=='undefined') ? supabase.createClient(CFG.supabase.url, CFG.supabase.anonKey) : null;

/* ---------- UTIL ---------- */
const fmtMoney = v => (Number(v||0).toFixed(2)+' €');
const pad = n => String(n).padStart(2,'0');
function fmtDateStr(d){
  const dt=(d instanceof Date)?d:new Date(d);
  return `${pad(dt.getDate())}.${pad(dt.getMonth()+1)}.${dt.getFullYear()}`;
}
const download = (name, blob) => {
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
};
const readDays = ()=> { try{ return JSON.parse(localStorage.getItem('arka_days_v1')||'[]'); }catch(e){ return [] } };

/* Email memory with your default */
(function initEmailDefault(){
  const key='arka_email_to';
  const existing = localStorage.getItem(key);
  if(!existing){
    localStorage.setItem(key, 'arbenoruci@gmail.com'); // your address
  }
})();

/* ---------- STATE ---------- */
let allDays = readDays(); // each day object created by ARKA close-day code
let filtered = [];
let selected = null; // the day object currently opened in details

/* ---------- RENDER LIST ---------- */
function totalSummary(day){
  const base = Number(day.base_cash||0);
  const trCash = Number(day.transport_cash||0);
  const expenses = Number(day.expenses_total||0);
  const borxhe = Number(day.debts_added||0);
  const totalIn = base + trCash;
  return {base, trCash, expenses, borxhe, totalIn, net: totalIn - expenses};
}

function rowHTML(day){
  const dt = new Date(day.date || day.day || Date.now());
  const sum = totalSummary(day);
  return `
  <div class="row">
    <div class="date">${fmtDateStr(dt)}</div>
    <div class="small">Bazë: <b>${fmtMoney(sum.base)}</b> • Transport: <b>${fmtMoney(sum.trCash)}</b> • Shpenzime: <b>${fmtMoney(sum.expenses)}</b> • Net: <b>${fmtMoney(sum.net)}</b></div>
    <div><button class="btn" data-open="${day.id || day.date}">Hap</button></div>
  </div>`;
}

function renderList(){
  const box = document.getElementById('daysList');
  filtered = [...allDays].sort((a,b)=>(new Date(b.date||b.day))-(new Date(a.date||a.day)));
  if(!filtered.length){ box.innerHTML = '<div class="small">S’ka ditë të mbyllura ende.</div>'; return; }
  box.innerHTML = filtered.map(rowHTML).join('');
}

/* ---------- DETAILS ---------- */
function humanTransporters(day){
  // day.transporters is expected from ARKA close (array of {name, delivered_m2, delivered_eur, paid_to_arka, missing})
  return Array.isArray(day.transporters) ? day.transporters : [];
}
function dayHTML(day){
  const sum = totalSummary(day);
  const trs = humanTransporters(day);
  const orders = Array.isArray(day.orders)? day.orders : []; // optional snapshot list of orders finished that day

  return `
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="panel">
      <div class="sectionTitle">Përmbledhje</div>
      <table class="table">
        <tr><th>Bazë (cash)</th><td>${fmtMoney(sum.base)}</td></tr>
        <tr><th>Transport (cash)</th><td>${fmtMoney(sum.trCash)}</td></tr>
        <tr><th>Shpenzime</th><td>${fmtMoney(sum.expenses)}</td></tr>
        <tr><th>Borxhe të shtuara</th><td>${fmtMoney(sum.borxhe)}</td></tr>
        <tr><th>Tot. brenda</th><td>${fmtMoney(sum.totalIn)}</td></tr>
        <tr><th>Netto</th><td><b>${fmtMoney(sum.net)}</b></td></tr>
      </table>
    </div>
    <div class="panel">
      <div class="sectionTitle">Transportuesit</div>
      <table class="table">
        <thead><tr><th>Emri</th><th>m²</th><th>€ totale</th><th>Pagoi</th><th>Mbete</th></tr></thead>
        <tbody>
          ${trs.length? trs.map(t=>`
            <tr>
              <td>${t.name||'-'}</td>
              <td>${Number(t.delivered_m2||0)}</td>
              <td>${fmtMoney(t.delivered_eur||0)}</td>
              <td>${fmtMoney(t.paid_to_arka||0)}</td>
              <td>${fmtMoney((t.delivered_eur||0)-(t.paid_to_arka||0))}</td>
            </tr>
          `).join('') : `<tr><td colspan="5" class="small">— s’ka të dhëna</td></tr>`}
        </tbody>
      </table>
    </div>
  </div>

  <div class="panel" style="margin-top:10px">
    <div class="sectionTitle">Porositë (opsionale)</div>
    <table class="table">
      <thead><tr><th>KODI</th><th>Klienti</th><th>Copë</th><th>m²</th><th>€</th><th>Pagesa</th></tr></thead>
      <tbody>
        ${orders.length? orders.map(o=>`
          <tr>
            <td>${o.client?.code||'-'}</td>
            <td>${o.client?.name||'-'}</td>
            <td>${o.pieces||0}</td>
            <td>${Number(o.pay?.m2||0).toFixed(2)}</td>
            <td>${fmtMoney(o.pay?.euro||0)}</td>
            <td>${o.pay?.paidUp ? ('Paguar '+fmtMoney(o.pay?.paid||0)) : (Number(o.pay?.debt||0)>0?'BORXH '+fmtMoney(o.pay?.debt):'-')}</td>
          </tr>
        `).join('') : `<tr><td colspan="6" class="small">— s’ka listë porosish në këtë ditë</td></tr>`}
      </tbody>
    </table>
  </div>`;
}

function openDay(id){
  selected = filtered.find(d=>(String(d.id||d.date)===String(id)));
  if(!selected) return;
  document.getElementById('dayTitle').innerHTML = `<b>Dita:</b> ${fmtDateStr(new Date(selected.date||selected.day))}`;
  document.getElementById('dayBody').innerHTML = dayHTML(selected);
  document.getElementById('dayDetails').style.display='block';
  // remember last opened day
  localStorage.setItem('arka_hist_last', String(selected.id||selected.date));
}

/* ---------- CSV / PDF / EMAIL ---------- */
function csvForDay(day){
  const lines = [];
  const sum = totalSummary(day);
  lines.push(['Dita', fmtDateStr(new Date(day.date||day.day))].join(','));
  lines.push(['Baza (€)', sum.base].join(','));
  lines.push(['Transport (€)', sum.trCash].join(','));
  lines.push(['Shpenzime (€)', sum.expenses].join(','));
  lines.push(['Borxhe (€)', sum.borxhe].join(','));
  lines.push(['Netto (€)', sum.net].join(','));
  lines.push([]);
  lines.push(['Transportuesi','m2','€ totale','Pagoi','Mbete'].join(','));
  for(const t of humanTransporters(day)){
    lines.push([t.name||'', t.delivered_m2||0, t.delivered_eur||0, t.paid_to_arka||0, (t.delivered_eur||0)-(t.paid_to_arka||0)].join(','));
  }
  lines.push([]);
  lines.push(['KODI','Klienti','Copë','m2','€','Pagesa'].join(','));
  (day.orders||[]).forEach(o=>{
    lines.push([
      o.client?.code||'',
      (o.client?.name||'').replaceAll(',',' '),
      o.pieces||0,
      Number(o.pay?.m2||0).toFixed(2),
      Number(o.pay?.euro||0).toFixed(2),
      o.pay?.paidUp ? `Paguar ${Number(o.pay?.paid||0).toFixed(2)}` : (Number(o.pay?.debt||0)>0?`BORXH ${Number(o.pay?.debt||0).toFixed(2)}`:'-')
    ].join(','));
  });
  return new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
}

async function pdfForDay(day){
  const el = document.getElementById('dayBody');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt', format:'a4'});
  const pageW = pdf.internal.pageSize.getWidth();
  // snapshot as image
  const canvas = await html2canvas(el, {scale:2, backgroundColor:'#0b1220'});
  const imgData = canvas.toDataURL('image/png');
  const imgW = pageW - 40; // 20pt margin each side
  const imgH = canvas.height * (imgW / canvas.width);
  pdf.setFillColor(11,18,32); pdf.rect(0,0,pageW,20,'F');
  pdf.text(`ARKA — ${fmtDateStr(new Date(day.date||day.day))}`, 20, 40);
  pdf.addImage(imgData, 'PNG', 20, 60, imgW, imgH);
  return pdf.output('blob');
}

async function uploadReportPDF(day, blob){
  if(!sb) throw new Error('Supabase client jo aktiv');
  const dateKey = (day.date||day.day||Date.now());
  const fname = `reports/arka_${String(dateKey)}.pdf`;
  const { error } = await sb.storage.from(CFG.supabase.bucket)
    .upload(fname, blob, { upsert:true, contentType:'application/pdf' });
  if(error) throw error;
  const { data } = sb.storage.from(CFG.supabase.bucket).getPublicUrl(fname);
  return data.publicUrl;
}

function openEmailLink(url, day){
  const to = (document.getElementById('emailTo').value||'').trim();
  const subject = encodeURIComponent(`Raporti i arkës — ${fmtDateStr(new Date(day.date||day.day))}`);
  const body = encodeURIComponent(
    `Përshëndetje,\n\nJu dërgojmë PDF raportin e ditës ${fmtDateStr(new Date(day.date||day.day))}.\nLinku i shkarkimit: ${url}\n\nFaleminderit!`
  );
  // fallback if no email:
  const mailto = `mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
  location.href = mailto;
}

/* ---------- HOOKS ---------- */
function attachEvents(){
  document.getElementById('daysList').addEventListener('click', (e)=>{
    const id = e.target?.getAttribute?.('data-open');
    if(id) openDay(id);
  });

  document.getElementById('btnCSV').addEventListener('click', ()=>{
    if(!selected) return;
    download(`arka_${String(selected.date||selected.day)}.csv`, csvForDay(selected));
  });

  document.getElementById('btnPDF').addEventListener('click', async ()=>{
    if(!selected) return;
    const blob = await pdfForDay(selected);
    download(`arka_${String(selected.date||selected.day)}.pdf`, blob);
  });

  document.getElementById('btnSendEmail').addEventListener('click', async ()=>{
    if(!selected) return;
    try{
      const blob = await pdfForDay(selected);
      const url = await uploadReportPDF(selected, blob);
      openEmailLink(url, selected);
      alert('PDF u ngarkua dhe linku u fut në email. Kontrollo klientin e email-it.');
    }catch(err){
      alert('S’u dërgua: '+(err?.message||err));
    }
  });

  // filters
  document.getElementById('filter7').addEventListener('click', ()=>{
    const now = new Date(); const from = new Date(now); from.setDate(now.getDate()-6);
    (document.getElementById('from').value) = from.toISOString().slice(0,10);
    (document.getElementById('to').value) = now.toISOString().slice(0,10);
    applyRange();
  });
  document.getElementById('filterThisWeek').addEventListener('click', ()=>{
    const now=new Date(); const day=now.getDay()||7; const monday=new Date(now);
    monday.setDate(now.getDate()-(day-1));
    const today = new Date();
    document.getElementById('from').value = monday.toISOString().slice(0,10);
    document.getElementById('to').value = today.toISOString().slice(0,10);
    applyRange();
  });
  document.getElementById('filterRange').addEventListener('click', applyRange);

  // email save
  const emailTo = document.getElementById('emailTo');
  const saved = localStorage.getItem('arka_email_to') || 'arbenoruci@gmail.com';
  emailTo.value = saved;
  document.getElementById('saveEmail').addEventListener('click', ()=>{
    const v = (emailTo.value||'').trim();
    if(!v) return alert('Vendos email-in');
    localStorage.setItem('arka_email_to', v);
    alert('U ruajt email-i i destinacionit.');
  });

  // open last opened day if any
  const last = localStorage.getItem('arka_hist_last');
  if(last){ setTimeout(()=> openDay(last), 0); }
}

function applyRange(){
  const f = document.getElementById('from').value;
  const t = document.getElementById('to').value;
  if(!f || !t){ renderList(); return; }
  const df = new Date(f+'T00:00:00'); const dt = new Date(t+'T23:59:59');
  filtered = readDays().filter(d=>{
    const dd = new Date(d.date||d.day||Date.now());
    return dd>=df && dd<=dt;
  }).sort((a,b)=>(new Date(b.date||b.day))-(new Date(a.date||a.day)));
  const box = document.getElementById('daysList');
  box.innerHTML = filtered.length ? filtered.map(rowHTML).join('') : '<div class="small">S’ka ditë në këtë interval.</div>';
  document.getElementById('dayDetails').style.display='none';
  selected=null;
}

/* ---------- INIT ---------- */
renderList();
attachEvents();
</script>
</body>
</html>