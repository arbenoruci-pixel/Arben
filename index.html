<!doctype html><html lang="sq">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>HOME â€¢ Big Buttons Inline Lists</title>
<style>
:root{
  --bg:#0b1220; --bg2:#0a111c;
  --panel:#0f1a2a; --panel2:#101a27;
  --line:#1f2e46; --text:#eaf1ff; --muted:#9fb4d6;
  --blue1:#1aa5d8; --blue2:#146b95;
  --green1:#19a25f; --green2:#0e6d3d;
  --amber1:#c78a2a; --amber2:#8a5f19;
  --red1:#ff5a5a; --red2:#8b2a2a;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1000px 600px at 50% -120px, rgba(255,255,255,.04), transparent), linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;letter-spacing:.2px}
a{color:inherit;text-decoration:none}
button{cursor:pointer}
.app{max-width:960px;margin:0 auto;padding:16px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}

.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#254369,#15263c);border:1px solid #203651;display:flex;align-items:center;justify-content:center}
.brand h1{margin:0;font-size:18px;letter-spacing:.6px}
.badge{background:linear-gradient(180deg,var(--blue1),var(--blue2));border:1px solid #1f6f97;color:#eaffff;padding:6px 10px;border-radius:999px;font-weight:1000}

.header-actions{display:flex;align-items:center;gap:8px}
.btnIcon{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;border:1px solid var(--line);background:#0f1a2a;font-size:14px}
.btnIcon:active{transform:scale(.98)}

.segment{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
@media (max-width:760px){.segment{grid-template-columns:repeat(2,minmax(0,1fr));}}
.seg{position:relative;display:flex;align-items:center;justify-content:center;height:54px;border-radius:12px;border:1px solid var(--line);text-transform:uppercase;font-weight:1000;background:linear-gradient(180deg,#1c2f46,#111a2b)}
.count{position:absolute;right:8px;top:8px;min-width:22px;height:22px;border-radius:999px;display:flex;align-items:center;justify-content:center;padding:0 7px;border:1px solid var(--line);font-size:12px}
.cPa{background:linear-gradient(180deg,var(--blue1),var(--blue2))}
.cPr{background:linear-gradient(180deg,#c44444,#812a2a)}
.cGa{background:linear-gradient(180deg,#1b9b5a,#0f6b3d)}
.cMa{background:linear-gradient(180deg,var(--amber1),var(--amber2))}

.btnBigWrap{display:flex;justify-content:center;margin:12px 0}
.btnBig{min-width:320px;max-width:520px;width:90%;padding:14px 18px;border-radius:14px;border:1px solid #2aa7d8;font-weight:1000;color:#fff;letter-spacing:.6px;text-transform:uppercase;box-shadow:0 2px 0 rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.06) inset;text-align:center}
.btnGreen{background:linear-gradient(180deg,var(--green1),var(--green2));}
.btnRed{background:linear-gradient(180deg,var(--red1),var(--red2));border-color:#a94444}
.btnOrange{background:linear-gradient(180deg,var(--amber1),var(--amber2));border-color:#8a5f19}
.btnBig .pill{margin-left:8px;min-width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;padding:0 8px;border-radius:999px;background:rgba(255,255,255,.15);border:1px solid rgba(0,0,0,.25);font-size:12px}

.inlinePanel{display:none; max-width:720px; margin:8px auto 0; padding:0 8px}
.list a.rowitem{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:#0e1930;border:1px solid var(--line);margin-top:8px}
.muted{color:#9fb4d6;font-size:12px}

.tools{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
@media (max-width:760px){.tools{grid-template-columns:1fr;}}
.card{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#101a31}
.row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.tag{margin-bottom:6px;font-weight:900;letter-spacing:.6px;color:#cbd7ef}
.input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0e1730;color:#fff;font-weight:900;letter-spacing:1px}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:10px;border:1px solid #2aa7d8;text-transform:uppercase;font-weight:1000;color:#fff;letter-spacing:.6px;box-shadow:0 2px 0 rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.06) inset}
.btn.search{background:linear-gradient(180deg,var(--blue1),var(--blue2));}
.small{font-size:12px;padding:8px 10px;border-radius:9px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo">ðŸ§¼</div>
      <div><h1>KOMPANIA JONI</h1><div class="muted">HOME</div></div>
    </div>
    <div class="header-actions">
      <button id="btnSync" class="btnIcon" title="Rifresko">âŸ³</button>
      <div class="badge">â‚¬ ARKA</div>
    </div>
  </div>

  <!-- MAIN STAGE BUTTONS -->
  <div class="panel">
    <div class="segment">
      <a class="seg" href="/pranimi/">PRANIMI <span class="count cPr" id="cPr">0</span></a>
      <a class="seg" href="/pastrimi/">PASTRIMI <span class="count cPa" id="cPa">0</span></a>
      <a class="seg" href="/gati/">GATI <span class="count cGa" id="cGa">0</span></a>
      <a class="seg" href="/marrje-sot/">MARRJE SOT <span class="count cMa" id="cMa">0</span></a>
    </div>
  </div>

  <!-- BIG BUTTONS STACKED -->
  <div class="btnBigWrap"><a class="btnBig btnGreen" href="/pranimi/" id="addX">ï¼‹ KLIENT I RI</a></div>
  <div class="btnBigWrap"><button class="btnBig btnRed" id="togglePap">PAPLOTÃ‹SUARA <span class="pill" id="countPap">0</span></button></div>
  <div class="inlinePanel" id="papPanel">
    <div id="papList" class="list muted">â€”</div>
  </div>
  <div class="btnBigWrap"><button class="btnBig btnOrange" id="toggleTA">ðŸšš TRANSPORT AKTIV <span class="pill" id="countTA">0</span></button></div>
  <div class="inlinePanel" id="taPanel">
    <div id="taList" class="list muted">â€”</div>
  </div>

  <!-- TOOLS -->
  <div class="tools">
    <div class="card">
      <div class="tag">KLIENTÃ‹T E BAZÃ‹S â€” KODI X</div>
      <div class="row">
        <input class="input" id="qX" placeholder="X01">
        <a class="btn search" id="searchX">KÃ‹RKO</a>
      </div>
    </div>

    <div class="card">
      <div class="tag">TRANSPORT â€” KODI T</div>
      <div class="row">
        <input class="input" id="qT" placeholder="T2">
        <a class="btn search" id="searchT">KÃ‹RKO</a>
      </div>
    </div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
  // Safe Supabase init (wonâ€™t crash if CDN blocked)
  const CFG = {
    supabase: {
      url: "https://vnidjrxidvusulinozbn.supabase.co",
      anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaWRqcnhpZHZ1c3VsaW5vemJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTk0NjAsImV4cCI6MjA3MzA5NTQ2MH0.hzGSFKU3sKuUKBUBsTE0rKIerj2uhG9pGS8_K9N7tpA",
      bucket: "tepiha-photos"
    }
  };
  const sb = (typeof supabase!=='undefined')
    ? supabase.createClient(CFG.supabase.url, CFG.supabase.anonKey)
    : null;
</script>

<script>
(function(){
  const LIST_KEY="order_list_v1"; const KEY=id=>`order_${id}`;
  const getIndex=()=>{try{return JSON.parse(localStorage.getItem(LIST_KEY)||"[]")}catch(e){return []}};
  const setIndex=idx=>localStorage.setItem(LIST_KEY, JSON.stringify(idx.slice(0,500)));
  const getOrder=id=>{try{return JSON.parse(localStorage.getItem(KEY(id))||"null")}catch(e){return null}};
  const text=s=>(s||"").toString();
  const fmtDate=ts=>{try{const d=new Date(ts||Date.now());const p=n=>String(n).padStart(2,"0");return `${p(d.getDate())}.${p(d.getMonth()+1)}.${p(d.getFullYear())} ${p(d.getHours())}:${p(d.getMinutes())}`}catch(e){return""}};
  const padX=n=>{n=parseInt(n)||0;return n<10?'X0'+n:'X'+n};

  // ---- Cloud sync (guard all sb usage) ----
  let syncing=false;
  async function syncFromCloud(){
    if(!sb || syncing) return; syncing=true;
    try{
      const { data:list, error } = await sb.storage.from(CFG.supabase.bucket)
        .list('orders', { limit: 10000, sortBy:{column:'name', order:'asc'} });
      if(error && error.message!=='The resource was not found') throw error;

      const idxMap=new Map((getIndex()||[]).map(x=>[x.id,x]));
      for(const f of (list||[])){
        if(!/\.json$/i.test(f.name)) continue;
        const path = `orders/${f.name}`;
        const { data:blob, error:dlErr } = await sb.storage.from(CFG.supabase.bucket).download(path);
        if(dlErr){ console.warn('download fail', path, dlErr.message); continue; }
        const txt = await blob.text();
        let o=null; try{ o=JSON.parse(txt); }catch(e){ continue; }
        if(!o || !o.id) continue;
        localStorage.setItem(KEY(o.id), JSON.stringify(o));
        idxMap.set(o.id, { id:o.id, name:o.client?.name||'', phone:o.client?.phone||'' });
      }
      setIndex(Array.from(idxMap.values()).sort((a,b)=> (a.id<b.id?1:-1)));
      render();
    }catch(e){
      console.warn('sync error', e?.message||e);
    }finally{ syncing=false; }
  }

  async function resolveXCodeToId(xcode){
    if(!sb) return null;
    try{
      const m=/^X(\d+)$/i.exec((xcode||'').trim().toUpperCase()); if(!m) return null;
      const path=`codes/x${parseInt(m[1],10)}.used`;
      const { data:blob, error } = await sb.storage.from(CFG.supabase.bucket).download(path);
      if(error) return null;
      const meta = JSON.parse(await blob.text());
      return meta?.id || null;
    }catch(e){ return null; }
  }

  // ---- Render & UI logic ----
  function render(){
    const idx=getIndex();
    const counts={pranim:0,pastrim:0,gati:0,marrje:0};
    let taCount=0;
    for(const row of idx){
      const o=getOrder(row.id); if(!o) continue;
      const s=String(o.status||'').toLowerCase();
      if(s==='pranim') counts.pranim++;
      else if(s==='pastrim') counts.pastrim++;
      else if(s==='gati') counts.gati++;
      else if(s==='marrje') counts.marrje++;
      const t=(o.transport&&o.transport.code)||o.transport_code||o.tcode||(o.client&&o.client.transportCode)||'';
      const active=!!t && s!=='marrje';
      if(active) taCount++;
    }
    document.getElementById('cPr').textContent=counts.pranim;
    document.getElementById('cPa').textContent=counts.pastrim;
    document.getElementById('cGa').textContent=counts.gati;
    document.getElementById('cMa').textContent=counts.marrje;
    document.getElementById('countPap').textContent=counts.pranim;
    document.getElementById('countTA').textContent=taCount;

    function fillPap(){
      const list=document.getElementById('papList'); const items=[];
      for(const row of idx){const o=getOrder(row.id); if(!o) continue;
        if(String(o.status||'').toLowerCase()==='pranim'){
          const name=text(o.client&&o.client.name)||'(pa emÃ«r)';
          const phone=text(o.client&&o.client.phone)||'';
          const raw=(o.client&&o.client.code)||'';
          const code=raw && /^X\d+$/.test(raw)?' â€¢ '+raw.replace(/^X(\d+)$/,(m,n)=>padX(n)):(raw?' â€¢ '+raw:'');
          const when=o.ts?' â€¢ '+fmtDate(o.ts):'';
          items.push({id:o.id,label:`${name} â€¢ ${phone}${code}${when}`});
        }
      }
      const listEl=document.getElementById('papList');
      if(!items.length){ listEl.textContent="Sâ€™KA POROSI TÃ‹ PAPLOTÃ‹SUARA."; }
      else { listEl.classList.remove('muted'); listEl.innerHTML=items.map(x=>`<a class="rowitem" href="/pranimi/?id=${x.id}"><div>${x.label}</div><div>âžœ</div></a>`).join(""); }
    }
    function fillTA(){
      const list=document.getElementById('taList'); const rows=[];
      for(const row of idx){const o=getOrder(row.id); if(!o) continue;
        const t=(o.transport&&o.transport.code)||o.transport_code||o.tcode||(o.client&&o.client.transportCode)||'';
        const s=String(o.status||'').toLowerCase();
        const active=!!t && s!=='marrje';
        if(active){
          const name=text(o.client&&o.client.name)||'(pa emÃ«r)';
          const when=o.ts?' â€¢ '+fmtDate(o.ts):'';
          rows.push(`<a class="rowitem" href="/transporti/?id=${o.id}"><div>${t} â€¢ ${name} â€¢ ${s.toUpperCase()}${when}</div><div>âžœ</div></a>`);
        }
      }
      const listEl=document.getElementById('taList');
      if(!rows.length){ listEl.textContent="Sâ€™KA TRANSPORT AKTIV."; }
      else { listEl.classList.remove('muted'); listEl.innerHTML=rows.join(""); }
    }

    // toggles
    document.getElementById('togglePap')?.addEventListener('click', ()=>{
      const p=document.getElementById('papPanel');
      p.style.display = (p.style.display==='block')?'none':'block';
      if(p.style.display==='block'){ fillPap(); p.scrollIntoView({behavior:'smooth'}); }
    });
    document.getElementById('toggleTA')?.addEventListener('click', ()=>{
      const p=document.getElementById('taPanel');
      p.style.display = (p.style.display==='block')?'none':'block';
      if(p.style.display==='block'){ fillTA(); p.scrollIntoView({behavior:'smooth'}); }
    });
  }

  // Search X â€” local, then cloud resolve, then full sync
  document.getElementById('searchX')?.addEventListener('click', async ()=>{
    const q=(document.getElementById('qX')?.value||'').trim().toUpperCase();
    if(!q) return;

    // 1) local
    for(const row of getIndex()){ const o=getOrder(row.id); if(!o) continue;
      if((o.client&&String(o.client.code||'').toUpperCase())===q){
        location.href=`/pranimi/?id=${o.id}`; return;
      }
    }
    // 2) cloud code resolve
    const resolved = await resolveXCodeToId(q);
    if(resolved && !getOrder(resolved)){
      const ok = await (async()=>{
        if(!sb) return false;
        const { data:blob, error } = await sb.storage.from(CFG.supabase.bucket).download(`orders/${resolved}.json`);
        if(error) return false;
        const order=JSON.parse(await blob.text());
        localStorage.setItem(KEY(order.id), JSON.stringify(order));
        const idxMap=new Map((getIndex()||[]).map(x=>[x.id,x]));
        idxMap.set(order.id,{id:order.id,name:order.client?.name||'',phone:order.client?.phone||''});
        setIndex(Array.from(idxMap.values()));
        return true;
      })();
      if(ok){ location.href=`/pranimi/?id=${resolved}`; return; }
    }
    // 3) full cloud sync then retry local
    await syncFromCloud();
    for(const row of getIndex()){ const o=getOrder(row.id); if(!o) continue;
      if((o.client&&String(o.client.code||'').toUpperCase())===q){
        location.href=`/pranimi/?id=${o.id}`; return;
      }
    }
    alert('Sâ€™u gjet KODI: '+q);
  });

  // Transport search (local; can be cloudified later)
  document.getElementById('searchT')?.addEventListener('click', ()=>{
    const q=(document.getElementById('qT')?.value||'').trim().toUpperCase(); if(!q)return;
    for(const row of getIndex()){const o=getOrder(row.id); if(!o) continue;
      const t=(o.transport&&o.transport.code)||o.transport_code||o.tcode||(o.client&&o.client.transportCode)||'';
      if(String(t).toUpperCase()===q){ location.href=`/transporti/?id=${o.id}`; return; }
    }
    alert('Sâ€™u gjet KODI T: '+q);
  });

  // Auto-sync (only if cloud client exists)
  const autoSync=()=>{ if(sb) syncFromCloud(); };
  window.addEventListener('focus', autoSync);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') autoSync(); });
  document.getElementById('btnSync')?.addEventListener('click', autoSync);

  // First render + initial (safe) sync
  render();
  autoSync();

  // On-page error helper so you see what went wrong next time
  window.addEventListener('error', function(e){
    const box=document.createElement('div');
    box.style.cssText='position:fixed;left:8px;right:8px;bottom:8px;background:#220; color:#fff; padding:10px;border:1px solid #933;border-radius:8px; z-index:99999; font-family:monospace; white-space:pre-wrap';
    box.textContent='JS ERROR: '+(e.message||'')+'\n'+(e.filename||'')+':'+(e.lineno||'');
    document.body.appendChild(box);
  });
})();
</script>
</body>
</html>