<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PASTRIMI</title>
  <style>
    :root{ --bg:#000; --ink:#fff; --panel:#0c0f16; --br:#273143; --btn:#1e60ff; --muted:#b9c4da }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:clamp(34px,5.4vw,50px);margin:14px 6px 10px;font-weight:1000}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 6px 16px}
    .input{flex:1;min-width:200px;background:#070a12;border:2px solid #2c3954;border-radius:12px;padding:12px 14px;color:#fff;font-weight:900}
    .btn{background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:1000;cursor:pointer}
    .list{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--panel);border:1px solid var(--br);border-radius:14px;padding:14px}
    .top{display:flex;justify-content:space-between;align-items:center;font-weight:1000}
    .small{opacity:.8;font-size:.95rem}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--br);border-radius:10px;padding:6px 10px;margin-top:6px}
    a.btnlink{display:inline-flex;align-items:center;gap:6px;background:#0c1220;border:1px solid var(--br);padding:10px 12px;border-radius:10px;color:#fff;text-decoration:none;font-weight:900}
    .row{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
    .status{padding:4px 8px;border-radius:8px;border:1px solid var(--br);font-weight:1000}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PASTRIMI</h1>
    <div class="bar">
      <input class="input" id="q" placeholder="K√´rko: em√´r, kod X#, tel‚Ä¶">
      <button class="btn" id="refresh">REFRESKO</button>
      <a class="btnlink" href="../">üè† KTHEU N√ã FILLIM</a>
      <a class="btnlink" href="../pranimi/">‚ûï SHTO T√ã RE</a>
    </div>
    <div class="list" id="orders">Duke u ngarkuar‚Ä¶</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    const CFG = {
      supabase: {
        url: "https://vnidjrxidvusulinozbn.supabase.co",
        anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaWRqcnhpZHZ1c3VsaW5vemJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTk0NjAsImV4cCI6MjA3MzA5NTQ2MH0.hzGSFKU3sKuUKBUBsTE0rKIerj2uhG9pGS8_K9N7tpA",
        bucket: "tepiha-photos"
      }
    };
    const sb = supabase.createClient(CFG.supabase.url, CFG.supabase.anonKey);

    async function listFiles(){
      const { data: files, error } = await sb.storage
        .from(CFG.supabase.bucket)
        .list('orders', { limit: 1000, sortBy: { column: 'name', order: 'desc' } });
      if(error){ throw error; }
      return (files||[]).filter(f=>f.name.endsWith('.json'));
    }

    async function fetchOrder(publicPath){
      const { data: pub } = sb.storage.from(CFG.supabase.bucket).getPublicUrl(publicPath);
      const url = pub?.publicUrl;
      if(!url) return null;
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) return null;
      return res.json();
    }

    function render(orders){
      const root = document.getElementById('orders');
      root.innerHTML = '';
      if(!orders.length){ root.textContent = 'S‚Äôka porosi t√´ sinkronizuara.'; return; }

      const term = (document.getElementById('q')?.value||'').toLowerCase().trim();
      const filtered = orders.filter(o=>{
        if(!term) return true;
        const name = (o?.client?.name||'').toLowerCase();
        const code = (o?.client?.code||'').toLowerCase();
        const phone= (o?.client?.phone||'').toLowerCase();
        return name.includes(term)||code.includes(term)||phone.includes(term);
      });

      filtered.sort((a,b)=> (b?.ts||0) - (a?.ts||0));

      if(!filtered.length){ root.textContent = 'Asgj√´ nuk p√´rputhet me k√´rkimin.'; return; }

      for(const o of filtered){
        const div = document.createElement('div');
        div.className = 'card';
        const m2 = (o?.pay?.m2 ?? 0);
        const euro = (o?.pay?.euro ?? 0);
        div.innerHTML = `
          <div class="row">
            <div class="top">
              <div><b>#${o?.client?.code || '-'}</b> ‚Äî ${o?.client?.name || 'Pa em√´r'}</div>
              <div class="status">${(o?.status||'pranim').toUpperCase()}</div>
            </div>
            <div class="small">M¬≤: ${m2} &nbsp;|&nbsp; ‚Ç¨: ${Number(euro).toFixed(2)}</div>
            <div class="small">${o?.client?.phone||''}</div>
          </div>
          <div class="pill">ID: ${o?.id || '-'}</div>
        `;
        root.appendChild(div);
      }
    }

    async function load(){
      try{
        const cards = await listFiles();
        const orders = [];
        for(const f of cards){
          const o = await fetchOrder(`orders/${f.name}`);
          if(o) orders.push(o);
        }
        render(orders);
      }catch(err){
        document.getElementById('orders').textContent = 'Gabim gjat√´ ngarkimit: ' + (err?.message||err);
      }
    }

    document.getElementById('refresh').addEventListener('click', load);
    document.getElementById('q').addEventListener('input', load);
    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>