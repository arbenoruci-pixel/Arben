<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PASTRIMI</title>
  <style>
    :root{
      --bg:#000; --ink:#fff; --muted:#b9c4da;
      --panel:#0c0f16; --panel-br:#273143; --line:#2c3954;
      --btn:#1e60ff; --btn-ink:#fff; --danger:#ef4444;
      --green:#19a25f; --red:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;font-size:15px}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    h1{font-size:clamp(28px,5vw,42px);margin:16px 0;font-weight:1000;letter-spacing:.01em;display:flex;align-items:center;justify-content:space-between}
    .badge{background:linear-gradient(180deg,#1aa5d8,#146b95);padding:6px 12px;border-radius:999px;font-weight:1000;font-size:.9rem}
    .panel{background:var(--panel);border:1px solid var(--panel-br);border-radius:14px;padding:12px;margin-top:12px}
    .head{display:grid;grid-template-columns:70px 1fr 60px 70px 160px;gap:6px;font-weight:1000;font-size:13px;color:var(--muted);padding:6px 8px}
    .row{display:grid;grid-template-columns:70px 1fr 60px 70px 160px;gap:6px;align-items:center;padding:8px;border-bottom:1px solid #12233a;font-size:14px}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;font-size:13px;color:#fff;text-decoration:none;text-align:center}
    .btn.green{background:var(--green)}
    .btn.red{background:var(--red)}
    .footer{position:fixed;left:0;right:0;bottom:0;background:#0c0f16;border-top:1px solid var(--panel-br);padding:12px;display:flex;justify-content:space-between;gap:10px}
    .footer .btn{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      PASTRIMI
      <span class="badge" id="activeCount">0 aktive</span>
    </h1>
    <div class="panel">
      <div class="head">
        <div>X NR</div><div>EMRI</div><div>COP√ã</div><div>M¬≤</div><div>VEPRIME</div>
      </div>
      <div id="list"></div>
    </div>
  </div>

  <div class="footer">
    <a href="../" class="btn">üè† KTHEU N√ã FILLIM</a>
    <button onclick="location.reload()" class="btn">üîÑ RIFRESKO</button>
  </div>

  <script>
  (function(){
    const listEl=document.getElementById('list');
    const dataKey='order_list_v1';
    const getIndex=()=>{try{return JSON.parse(localStorage.getItem(dataKey)||'[]')}catch{return[]}};
    const getOrder=id=>{try{return JSON.parse(localStorage.getItem('order_'+id)||'null')}catch{return null}};

    function render(){
      const idx=getIndex(); let active=0;
      listEl.innerHTML='';
      idx.forEach(r=>{
        const o=getOrder(r.id); if(!o) return;
        if(o.status!=='pastrim') return;
        active++;
        const div=document.createElement('div'); div.className='row';
        const pieces=(o.tepiha?.length||0)+(o.staza?.length||0)+(o.shkallore?.qty>0?1:0);
        const euro=o.pay?.euro?.toFixed(2)||'0.00';
        div.innerHTML=`
          <div>${o.client?.code||''}</div>
          <div>${o.client?.name||''}</div>
          <div>${pieces}</div>
          <div>${o.pay?.m2?.toFixed(2)||'0.00'}</div>
          <div class="actions">
            <button class="btn green" onclick="sendMsg('${o.client?.phone}','${o.client?.name}','${pieces}','${o.pay?.m2}','${euro}')">üì© D√ãRGO</button>
            <button class="btn red" onclick="markDone('${o.id}')">‚úÖ GATI SOT</button>
          </div>
        `;
        listEl.appendChild(div);
      });
      document.getElementById('activeCount').textContent=active+' aktive';
    }

    function sendMsg(phone,name,pieces,m2,euro){
      const msg=`P√´rsh√´ndetje ${name||'Klient'}, porosia juaj (${pieces} cop√´, ${m2} m¬≤) √´sht√´ GATI.\nTotali: ${euro} ‚Ç¨.\nJu lutem ejani ta merrni sot (deri n√´ or√´n 21:00).\n‚òéÔ∏è +38344735312`;
      const enc=encodeURIComponent(msg);
      const digits=(phone||'').replace(/[^\d]/g,'');
      const viber=`viber://forward?text=${enc}`;
      const wa=digits?`https://wa.me/${digits}?text=${enc}`:`https://wa.me/?text=${enc}`;
      const sms=digits?`sms:${digits}?body=${enc}`:`sms:?body=${enc}`;
      // open priority Viber
      window.location.href=viber;
      // fallback if not installed
      setTimeout(()=>{window.open(wa,'_blank')},800);
    }

    function markDone(id){
      const key='order_'+id;
      const o=getOrder(id); if(!o) return;
      o.status='gati';
      localStorage.setItem(key, JSON.stringify(o));
      render();
    }

    render();
  })();
  </script>
</body>
</html>