<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GATI ‚Ä¢ SOT</title>
  <style>
    :root{
      --bg:#0b1220; --ink:#eaf1ff; --muted:#9fb4d6;
      --panel:#0f1a2a; --line:#1f2e46;
      --ok:#0f6b3d; --ok-br:#185a3f;
      --warn:#8b2a2a; --warn-br:#5a2a2a;
      --btn:#1e60ff; --btn-br:#2aa7d8;
      --ghost:#101a31; --ghost-br:#2b3a55;
      --rowH:46px; --rad:12px; --pad:12px;
      --compact:13.5px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    .app{max-width:960px;margin:0 auto;padding:14px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#254369,#15263c);border:1px solid #203651;display:flex;align-items:center;justify-content:center}
    .badge{background:#10213a;border:1px solid #284160;padding:6px 10px;border-radius:999px;font-weight:1000;color:#cfe7ff}
    .title{margin:0;font-size:18px;letter-spacing:.4px}
    .muted{color:var(--muted);font-size:12px}

    .panel{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:14px;padding:10px}

    /* Row list ‚Äî ultra-compact, single line */
    .list{display:flex;flex-direction:column;gap:6px}
    .rowitem{
      display:grid;grid-template-columns:1fr auto;gap:8px;
      align-items:center;background:#0e1930;border:1px solid var(--line);
      border-radius:10px;padding:6px 8px;min-height:var(--rowH);
      font-size:var(--compact);line-height:1.1;
      white-space:nowrap;overflow:hidden;
    }
    .rowitem.overdue{background:#2a1212;border-color:#5a2a2a}
    .line{overflow:hidden;text-overflow:ellipsis}
    .actions{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;
      height:32px;padding:0 10px;border-radius:10px;border:1px solid var(--btn-br);
      background:linear-gradient(180deg,#1e60ff,#1340a6);color:#fff;font-weight:1000;
      font-size:12px;white-space:nowrap;cursor:pointer}
    .btn.ghost{background:var(--ghost);border-color:var(--ghost-br);color:#eaf1ff}
    .pill{display:inline-flex;align-items:center;justify-content:center;height:26px;padding:0 8px;border-radius:999px;font-weight:1000;font-size:12px;border:1px solid transparent}
    .pill.ok{background:var(--ok);border-color:var(--ok-br)}
    .pill.debt{background:var(--warn);border-color:var(--warn-br)}

    /* Footer nav */
    .footer{position:sticky;bottom:0;left:0;right:0;background:rgba(11,18,32,.97);border-top:1px solid var(--line);backdrop-filter:blur(6px)}
    .footwrap{max-width:960px;margin:0 auto;padding:10px;display:grid;grid-template-columns:auto auto;gap:10px;align-items:center;justify-content:space-between}
    .btnnav{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;border:1px solid var(--btn-br);background:#12306b;color:#fff;font-weight:1000}

    /* Share sheet (message) */
    .sheet{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99998;align-items:flex-end;justify-content:center}
    .sheet>.box{width:100%;max-width:720px;background:#0c0f16;border:1px solid #273143;border-radius:14px 14px 0 0;padding:14px}
    .sheet .title{font-weight:1000;font-size:1.1rem;margin:6px 4px 10px;color:#eaf1ff}
    .sheet .opt{display:block;text-align:center;margin:8px 4px;padding:12px;border-radius:12px;background:#1e60ff;color:#fff;font-weight:1000;border:1px solid #2aa7d8}
    .sheet .opt.wa{background:#114c3c;border-color:#1b7d63}
    .sheet .opt.sms{background:#3b3b3b;border-color:#6a6a6a}
    .sheet .opt.cancel{background:#0c1220;border-color:#2b3956}

    /* Payment modal */
    #payModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99999;align-items:flex-end;justify-content:center}
    #payModal .box{width:100%;max-width:720px;background:#0c0f16;border:1px solid #273143;border-radius:14px 14px 0 0;padding:14px}
    #payModal .title{font-weight:1000;font-size:1.1rem;margin:6px 4px 10px;color:#eaf1ff}
    #payInfo{color:#bcd0f0;font-weight:900;margin:0 4px 10px}
    .input{flex:1;padding:10px;border-radius:10px;border:1px solid #2b3a55;background:#0e1730;color:#fff;font-weight:900;letter-spacing:.6px;font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">‚úÖ</div>
        <div><h1 class="title">GATI ‚Ä¢ SOT</h1><div class="muted">Lista e porosive t√´ gatshme sot</div></div>
      </div>
      <div class="badge" id="debtsBadge">‚Ç¨ ARKA</div>
    </div>

    <div class="panel">
      <div id="list" class="list"></div>
    </div>
  </div>

  <!-- Footer Nav -->
  <div class="footer">
    <div class="footwrap">
      <a class="btnnav" href="../">üè† KTHEU N√ã FILLIM</a>
      <a class="btnnav" href="../pastrimi/">‚¨ÖÔ∏è TE PASTRIMI</a>
    </div>
  </div>

  <!-- Share Sheet (Message options) -->
  <div id="msgSheet" class="sheet" role="dialog" aria-modal="true">
    <div class="box">
      <div class="title">D√´rgo me:</div>
      <a id="optViber" class="opt" target="_blank" rel="noopener">Viber</a>
      <a id="optWA" class="opt wa" target="_blank" rel="noopener">WhatsApp</a>
      <a id="optSMS" class="opt sms">SMS</a>
      <button id="optCancel" class="opt cancel">Anulo</button>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="payModal" role="dialog" aria-modal="true">
    <div class="box">
      <div class="title">Pagesa</div>
      <div id="payInfo"></div>
      <div style="display:grid;grid-template-columns:1fr;gap:8px">
        <button id="btnPaidFull" class="btn" style="background:#198754;border:0">Pagoi plot√´</button>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="partialAmt" class="input" inputmode="decimal" placeholder="Shuma pjes√´risht (‚Ç¨)">
          <button id="btnPartial" class="btn">Ruaj pjes√´risht</button>
        </div>
        <button id="btnBorxh" class="btn" style="background:#8b2a2a;border:0">BORXH</button>
        <button id="btnClosePay" class="btn ghost">Mbyll</button>
      </div>
    </div>
  </div>

<script>
(function(){
  /* ========= Storage helpers ========= */
  const LIST_KEY='order_list_v1';
  const KEY=id=>'order_'+id;
  const getIndex=()=>{try{return JSON.parse(localStorage.getItem(LIST_KEY)||'[]')}catch(e){return []}};
  const getOrder=id=>{try{return JSON.parse(localStorage.getItem(KEY(id))||'null')}catch(e){return null}};
  const saveOrder=o=>localStorage.setItem(KEY(o.id), JSON.stringify(o));

  /* ========= Date / overdue helpers ========= */
  const fmt2=n=>String(n).padStart(2,'0');
  function ymd(ts){
    const d=new Date(ts||Date.now());
    return `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;
  }
  function isOverdue(order){
    // Prefer a specific "gatiAt" timestamp if present; fallback to the last update ts
    const when = order.gatiAt || order.ts || Date.now();
    return ymd(when) !== ymd(Date.now());
  }

  /* ========= Payment normalize ========= */
  function round2(x){ return Math.round((Number(x)+Number.EPSILON)*100)/100; }
  function normalizePay(pay){
    const m2   = Number(pay?.m2||0);
    const rate = Number(pay?.rate||0);
    const euro = round2(m2*rate);
    let paid   = Number(pay?.paid||0); if(paid<0) paid=0;
    let debt   = Math.max(0, round2(euro - paid));
    const paidUp = debt===0;
    return {m2,rate,euro,paid,debt,paidUp,isDebt:!!pay?.isDebt};
  }
  function setPaidFull(o){ const p=normalizePay(o.pay||{}); p.paid=p.euro; p.debt=0; p.paidUp=true; p.isDebt=false; o.pay=p; saveOrder(o); return p; }
  function setPaidPartial(o,amount){
    const p=normalizePay(o.pay||{}); const a=Math.max(0, Number(amount)||0);
    p.paid = Math.min(p.euro, a); p.debt = Math.max(0, round2(p.euro - p.paid)); p.paidUp = (p.debt===0); p.isDebt = p.debt>0; o.pay=p; saveOrder(o); return p;
  }
  function setBorxh(o){ const p=normalizePay(o.pay||{}); p.paid=0; p.debt=p.euro; p.paidUp=false; p.isDebt=true; o.pay=p; saveOrder(o); return p; }

  /* ========= Message building (Viber-first) ========= */
  const COMPANY_PHONE = '+38344735312';
  function buildMsg(o){
    const name  = (o.client?.name||'Klient');
    const euro  = round2(o.pay?.euro||0).toFixed(2);
    const code  = (o.client?.code||'').toUpperCase();
    return `P√´rsh√´ndetje ${name}, porosia juaj (${code}) √´sht√´ GATI SOT. Totali: ‚Ç¨${euro}. `+
           `Ju lutemi ta merrni sot deri n√´ ora 21:00 ‚Äî s‚Äôkemi vend p√´r ruajtje. `+
           `N√´se keni pyetje, telefononi: ${COMPANY_PHONE}. Faleminderit!`;
  }
  function makeTargets(o){
    const msg = encodeURIComponent(buildMsg(o));
    const digits = String(o.client?.phone||'').replace(/[^\d]/g,''); // for WA/SMS
    const viber = `viber://forward?text=${msg}`;
    const wa = digits ? `https://wa.me/${digits}?text=${msg}` : `https://wa.me/?text=${msg}`;
    const sms = digits ? `sms:${digits}?body=${msg}` : `sms:?body=${msg}`;
    return {viber, wa, sms};
  }

  /* ========= Share Sheet wiring ========= */
  let _sheetOrderId = null;
  function openSheet(orderId){
    _sheetOrderId = orderId;
    const o = getOrder(orderId); if(!o) return;
    const {viber,wa,sms} = makeTargets(o);
    const $ = id=>document.getElementById(id);
    $('optViber').href = viber;
    $('optWA').href = wa;
    $('optSMS').onclick = ()=>{ location.href = sms; };
    $('msgSheet').style.display='flex';
  }
  function closeSheet(){ document.getElementById('msgSheet').style.display='none'; _sheetOrderId=null; }
  document.getElementById('optCancel')?.addEventListener('click', closeSheet);

  // Single-tap: go straight to Viber; long-press: open sheet
  function wireMessageButton(btn, order){
    let pressTimer=null, long=false;
    const goViber = ()=>{
      const {viber} = makeTargets(order);
      // Try Viber first:
      window.location.href = viber;
    };
    btn.addEventListener('touchstart', e=>{
      long=false;
      pressTimer=setTimeout(()=>{ long=true; openSheet(order.id); }, 450);
    });
    btn.addEventListener('touchend', e=>{
      clearTimeout(pressTimer);
      if(!long) goViber();
    });
    btn.addEventListener('mousedown', e=>{
      long=false;
      pressTimer=setTimeout(()=>{ long=true; openSheet(order.id); }, 500);
    });
    btn.addEventListener('mouseup', e=>{
      clearTimeout(pressTimer);
      if(!long) goViber();
    });
    btn.addEventListener('mouseleave', ()=>clearTimeout(pressTimer));
    btn.addEventListener('click', e=>{
      // Desktop quick-click ‚Üí Viber
      if(!long) goViber();
    });
  }

  /* ========= Payment modal wiring ========= */
  let _payTargetId=null;
  function openPayModal(orderId){
    _payTargetId = orderId;
    const o=getOrder(orderId); if(!o) return;
    const p=normalizePay(o.pay||{});
    document.getElementById('payInfo').textContent =
      `Totali: ‚Ç¨${p.euro.toFixed(2)} ‚Ä¢ Paguar: ‚Ç¨${p.paid.toFixed(2)} ‚Ä¢ Borxh: ‚Ç¨${p.debt.toFixed(2)}`;
    document.getElementById('partialAmt').value = '';
    document.getElementById('payModal').style.display='flex';
  }
  function closePayModal(){ document.getElementById('payModal').style.display='none'; _payTargetId=null; }
  document.getElementById('btnClosePay')?.addEventListener('click', closePayModal);
  document.getElementById('btnPaidFull')?.addEventListener('click', ()=>{
    if(!_payTargetId) return;
    const o=getOrder(_payTargetId); if(!o) return;
    setPaidFull(o); refreshRow(_payTargetId); closePayModal();
  });
  document.getElementById('btnPartial')?.addEventListener('click', ()=>{
    if(!_payTargetId) return;
    const amt=(document.getElementById('partialAmt').value||'').trim();
    const o=getOrder(_payTargetId); if(!o) return;
    setPaidPartial(o, amt); refreshRow(_payTargetId); closePayModal();
  });
  document.getElementById('btnBorxh')?.addEventListener('click', ()=>{
    if(!_payTargetId) return;
    const o=getOrder(_payTargetId); if(!o) return;
    setBorxh(o); refreshRow(_payTargetId); closePayModal();
  });

  /* ========= Render list ========= */
  function piecesCount(o){
    return (o.tepiha?.length||0) + (o.staza?.length||0) + ((o.shkallore?.qty||0)>0?1:0);
  }
  function rowStatusUI(o){
    const p = normalizePay(o.pay||{});
    if(p.debt===0 && (p.euro>0 || p.paid>0)) return `<span class="pill ok">‚úîÔ∏è PAGUAR</span>`;
    if(p.debt>0 || p.isDebt) return `<span class="pill debt">BORXH</span><button class="btn" data-pay="${o.id}">üí∂</button>`;
    return `<button class="btn" data-pay="${o.id}">üí∂</button>`;
  }
  function rowClass(o){
    return isOverdue(o) ? 'rowitem overdue' : 'rowitem';
  }
  function rowLine(o){
    const code=(o.client?.code||'').toUpperCase();
    const name=(o.client?.name||'(pa em√´r)').trim();
    const m2  = Number(o.pay?.m2||0).toFixed(0);
    const pcs = piecesCount(o);
    return `${code} ‚Ä¢ ${name} ‚Ä¢ ${m2} m¬≤ ‚Ä¢ ${pcs} cop√´`;
  }

  function renderList(){
    const listEl=document.getElementById('list');
    const idx=getIndex();

    // Collect orders with status 'gati'
    const rows=[];
    for(const it of idx){
      const o=getOrder(it.id); if(!o) continue;
      const st=String(o.status||'').toLowerCase();
      if(st==='gati'){ rows.push(o); }
    }
    // Sort newest first by timestamp
    rows.sort((a,b)=> (b.ts||0)-(a.ts||0));

    if(!rows.length){
      listEl.innerHTML = `<div class="muted" style="padding:10px">‚Äî Nuk ka porosi GATI sot.</div>`;
      updateDebtsBadge();
      return;
    }

    listEl.innerHTML = rows.map(o=>`
      <div class="${rowClass(o)}" data-id="${o.id}">
        <div class="line">${rowLine(o)}</div>
        <div class="actions">
          <button class="btn ghost" data-msg="${o.id}" title="D√´rgo Mesazh">üì©</button>
          ${rowStatusUI(o)}
        </div>
      </div>
    `).join('');

    // Wire message + pay buttons
    listEl.querySelectorAll('[data-msg]').forEach(btn=>{
      const id=btn.getAttribute('data-msg'); const o=getOrder(id); if(!o) return;
      wireMessageButton(btn, o);
    });
    listEl.querySelectorAll('[data-pay]').forEach(btn=>{
      const id=btn.getAttribute('data-pay');
      btn.addEventListener('click', ()=>openPayModal(id));
    });

    updateDebtsBadge();
  }

  function refreshRow(orderId){
    const wrapper = document.querySelector(`.rowitem[data-id="${orderId}"]`);
    if(!wrapper){ renderList(); return; }
    const o=getOrder(orderId); if(!o){ wrapper.remove(); return; }

    wrapper.className = rowClass(o);
    wrapper.querySelector('.line').textContent = rowLine(o);

    const actions = wrapper.querySelector('.actions');
    const msgBtn = actions.querySelector('[data-msg]');
    // re-render payment area
    const paymentArea = document.createElement('div');
    paymentArea.innerHTML = rowStatusUI(o);
    // Keep existing message button, re-wire payment
    actions.innerHTML = '';
    actions.appendChild(msgBtn);
    Array.from(paymentArea.childNodes).forEach(n=>actions.appendChild(n));

    // rewire
    const newPay = actions.querySelector('[data-pay]');
    if(newPay){
      const id=newPay.getAttribute('data-pay');
      newPay.addEventListener('click', ()=>openPayModal(id));
    }
  }

  /* ========= Debts badge on top ========= */
  function updateDebtsBadge(){
    const idx=getIndex();
    let n=0;
    for(const it of idx){
      const o=getOrder(it.id); if(!o) continue;
      const p=o.pay||{};
      if(Number(p.debt||0)>0) n++;
    }
    const b=document.getElementById('debtsBadge');
    b.textContent = n>0 ? `‚Ç¨ ARKA (${n})` : `‚Ç¨ ARKA`;
    b.style.cursor='pointer';
    b.onclick=()=> location.href='../arka/';
  }

  renderList();

})();
</script>
</body>
</html>